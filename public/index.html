<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Connect - Enterprise MCP Server Management</title>
  <meta name="description" content="Unified control plane for Model Context Protocol servers">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#x26A1;</text></svg>">
  <link rel="stylesheet" href="/css/mobile.css">
  <link rel="stylesheet" href="/css/animations.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-card: rgba(255,255,255,0.02);
      --border-color: rgba(255,255,255,0.06);
      --border-hover: rgba(255,255,255,0.12);
      --text-primary: #f4f4f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
      --success: #22c55e;
      --success-bg: rgba(34, 197, 94, 0.15);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.15);
      --error: #ef4444;
      --error-bg: rgba(239, 68, 68, 0.15);
      --info: #3b82f6;
      --info-bg: rgba(59, 130, 246, 0.15);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.5);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --transition: all 0.2s ease;
    }

    /* Light theme */
    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-card: rgba(0,0,0,0.02);
      --border-color: rgba(0,0,0,0.08);
      --border-hover: rgba(0,0,0,0.15);
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    /* Layout */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: var(--accent-gradient);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo-version {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-primary);
    }

    .nav-item-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .nav-item-badge {
      margin-left: auto;
      background: var(--accent-gradient);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 24px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border-color);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      font-size: 13px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.connected {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .status-indicator.disconnected {
      background: var(--text-muted);
    }

    .status-indicator.error {
      background: var(--error);
      box-shadow: 0 0 8px var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
    }

    /* Top bar */
    .top-bar {
      height: 64px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .breadcrumb-divider {
      color: var(--text-muted);
    }

    .breadcrumb-current {
      color: var(--text-primary);
      font-weight: 600;
    }

    .top-bar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .search-box {
      width: 320px;
      padding: 10px 16px 10px 40px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 14px center;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .search-box::placeholder {
      color: var(--text-muted);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: white;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .btn-error {
      background: var(--error);
      color: white;
    }

    .btn-error:hover {
      background: #dc2626;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Data tables */
    .table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
    }

    .data-table td {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .data-table tr:hover td {
      background: var(--bg-card);
    }

    .data-table code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 18px;
    }

    .btn-icon:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    /* Page content */
    .page-content {
      padding: 32px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    @media (max-width: 1400px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent-gradient);
      opacity: 0;
      transition: var(--transition);
    }

    .stat-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .stat-card-icon.servers { background: var(--info-bg); }
    .stat-card-icon.tools { background: var(--success-bg); }
    .stat-card-icon.requests { background: var(--warning-bg); }
    .stat-card-icon.uptime { background: rgba(139, 92, 246, 0.15); }

    .stat-card-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
    }

    .stat-card-trend.up {
      background: var(--success-bg);
      color: var(--success);
    }

    .stat-card-trend.down {
      background: var(--error-bg);
      color: var(--error);
    }

    .stat-card-value {
      font-size: 36px;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 4px;
    }

    .stat-card-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Dashboard grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 24px;
    }

    .card-body.no-padding {
      padding: 0;
    }

    /* Chart container */
    .chart-container {
      position: relative;
      height: 280px;
      padding: 16px;
    }

    /* Activity feed */
    .activity-feed {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 14px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .activity-item:hover {
      background: var(--bg-tertiary);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-icon.connect { background: var(--success-bg); }
    .activity-icon.disconnect { background: var(--error-bg); }
    .activity-icon.invoke { background: var(--info-bg); }
    .activity-icon.error { background: var(--warning-bg); }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-description {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* Server cards grid */
    .servers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .server-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      transition: var(--transition);
    }

    .server-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .server-card-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .server-icon {
      width: 52px;
      height: 52px;
      background: var(--accent-gradient);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .server-info {
      flex: 1;
      min-width: 0;
    }

    .server-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .server-category {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .server-status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .server-status-badge.connected {
      background: var(--success-bg);
      color: var(--success);
    }

    .server-status-badge.disconnected {
      background: rgba(161, 161, 170, 0.15);
      color: var(--text-muted);
    }

    .server-status-badge.error {
      background: var(--error-bg);
      color: var(--error);
    }

    .server-status-badge.connecting {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .server-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .server-stat {
      text-align: center;
    }

    .server-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .server-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .server-actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .server-actions .btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
    }

    /* Tools list */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .tool-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      cursor: pointer;
      transition: var(--transition);
    }

    .tool-card:hover {
      border-color: var(--accent-primary);
      background: rgba(99, 102, 241, 0.05);
      transform: translateY(-2px);
    }

    .tool-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-primary);
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      margin-bottom: 8px;
    }

    .tool-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .tool-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-tag {
      background: var(--bg-tertiary);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Circuit breaker indicators */
    .circuit-breakers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .circuit-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border-left: 3px solid;
    }

    .circuit-indicator.closed {
      border-left-color: var(--success);
    }

    .circuit-indicator.open {
      border-left-color: var(--error);
    }

    .circuit-indicator.half_open {
      border-left-color: var(--warning);
    }

    .circuit-server {
      font-size: 13px;
      font-weight: 500;
    }

    .circuit-state {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
      margin-left: auto;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
    }

    .circuit-state.closed {
      background: var(--success-bg);
      color: var(--success);
    }

    .circuit-state.open {
      background: var(--error-bg);
      color: var(--error);
    }

    .circuit-state.half_open {
      background: var(--warning-bg);
      color: var(--warning);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* Filters */
    .filters-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .filter-chip:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .filter-chip.active {
      background: rgba(99, 102, 241, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    /* Loading states */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-color) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-content {
        padding: 16px;
      }

      .top-bar {
        padding: 0 16px;
      }

      .search-box {
        display: none;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
      min-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--error); }
    .toast.warning { border-left: 3px solid var(--warning); }
    .toast.info { border-left: 3px solid var(--info); }

    .toast-icon {
      font-size: 18px;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }

    /* Live indicator */
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--success-bg);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    /* API Key Banner */
    .api-key-banner {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .api-key-banner.hidden {
      display: none;
    }

    .api-key-banner-icon {
      font-size: 20px;
    }

    .api-key-banner-text {
      flex: 1;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .api-key-input {
      width: 320px;
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
    }

    .api-key-input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .api-key-input::placeholder {
      color: var(--text-muted);
    }

    /* Filter chips */
    .filters-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-chip:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .filter-chip.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    /* Tools grid for templates */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .tool-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tool-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .tool-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .tool-description {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .tool-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tool-tag {
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--error-bg);
      color: var(--error);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(85vh - 140px);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'JetBrains Mono', monospace;
    }

    .form-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Tool invocation result */
    .result-container {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 16px;
    }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .result-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    .result-status.success { color: var(--success); }
    .result-status.error { color: var(--error); }

    .result-output {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
      color: var(--text-secondary);
    }

    .error-help {
      margin-top: 12px;
      padding: 12px;
      background: var(--warning-bg);
      border: 1px solid var(--warning);
      border-radius: var(--radius-sm);
      color: var(--warning);
      font-size: 13px;
    }

    .alert {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 13px;
    }

    .alert-info {
      background: var(--info-bg);
      border: 1px solid var(--info);
      color: var(--info);
    }

    .alert-warning {
      background: var(--warning-bg);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    /* Keyboard shortcut hints */
    .kbd {
      display: inline-block;
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Command palette */
    .command-palette {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 560px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 1001;
      display: none;
    }

    .command-palette.active {
      display: block;
    }

    .command-input {
      width: 100%;
      padding: 16px 20px;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
    }

    .command-input:focus {
      outline: none;
    }

    .command-results {
      max-height: 320px;
      overflow-y: auto;
    }

    .command-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .command-item:hover, .command-item.selected {
      background: var(--bg-tertiary);
    }

    .command-item-icon {
      font-size: 18px;
    }

    .command-item-text {
      flex: 1;
    }

    .command-item-title {
      font-size: 14px;
      color: var(--text-primary);
    }

    .command-item-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Copy button */
    .copy-btn {
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    .copy-btn.copied {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    /* Theme toggle */
    .theme-toggle {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* Notifications Panel */
    .notifications-wrapper {
      position: relative;
    }

    .notifications-btn {
      position: relative;
      width: 40px;
      height: 40px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      transition: var(--transition);
    }

    .notifications-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--error);
      border-radius: 50%;
      font-size: 10px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-badge.hidden {
      display: none;
    }

    .notifications-panel {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      width: 380px;
      max-height: 480px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 200;
      display: none;
      overflow: hidden;
    }

    .notifications-panel.active {
      display: block;
    }

    .notifications-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .notifications-title {
      font-weight: 600;
      font-size: 14px;
    }

    .notifications-clear {
      font-size: 12px;
      color: var(--accent-primary);
      cursor: pointer;
      background: none;
      border: none;
    }

    .notifications-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: background 0.2s ease;
    }

    .notification-item:hover {
      background: var(--bg-tertiary);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item.unread {
      background: rgba(99, 102, 241, 0.05);
      border-left: 3px solid var(--accent-primary);
      padding-left: 13px;
    }

    .notification-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-message {
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Quick Actions */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
    }

    .quick-action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .quick-action-icon {
      font-size: 24px;
    }

    .quick-action-label {
      font-size: 13px;
      font-weight: 500;
    }

    /* Performance Chart Grid */
    .metrics-chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 1200px) {
      .metrics-chart-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Mobile Menu */
    .mobile-menu-btn {
      display: none;
      width: 40px;
      height: 40px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      align-items: center;
      justify-content: center;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: flex;
      }
    }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .servers-grid { grid-template-columns: 1fr; }
      .tools-grid { grid-template-columns: 1fr; }
      .page-header { flex-direction: column; gap: 16px; align-items: flex-start; }
      .top-bar { padding: 12px 16px; }
      .page-content { padding: 16px; }
      .quick-actions-grid { grid-template-columns: repeat(2, 1fr); }
      .notifications-panel { width: 320px; right: -50px; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .search-box { width: 200px; }
    }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr; }
      .quick-actions-grid { grid-template-columns: 1fr; }
      .notifications-panel { width: 290px; right: -80px; }
      .top-bar-actions { gap: 8px; }
      .search-box { display: none; }
    }
  </style>
</head>
<body>
  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()"></div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">&#x26A1;</div>
          <div>
            <div class="logo-text">MCP Connect</div>
            <div class="logo-version" id="version">v0.1.0</div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <div class="nav-item active" data-page="dashboard">
            <span class="nav-item-icon">&#x1F4CA;</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" data-page="servers">
            <span class="nav-item-icon">&#x1F5A5;</span>
            <span>Servers</span>
            <span class="nav-item-badge" id="nav-server-count">0</span>
          </div>
          <div class="nav-item" data-page="tools">
            <span class="nav-item-icon">&#x1F6E0;</span>
            <span>Tools</span>
            <span class="nav-item-badge" id="nav-tool-count">0</span>
          </div>
          <div class="nav-item" data-page="resources">
            <span class="nav-item-icon">&#x1F4C2;</span>
            <span>Resources</span>
            <span class="nav-item-badge" id="nav-resource-count">0</span>
          </div>
          <div class="nav-item" data-page="prompts">
            <span class="nav-item-icon">&#x1F4AC;</span>
            <span>Prompts</span>
            <span class="nav-item-badge" id="nav-prompt-count">0</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Management</div>
          <div class="nav-item" data-page="templates">
            <span class="nav-item-icon">&#x1F4CB;</span>
            <span>Templates</span>
          </div>
          <div class="nav-item" data-page="api-keys">
            <span class="nav-item-icon">&#x1F511;</span>
            <span>API Keys</span>
          </div>
          <div class="nav-item" data-page="groups">
            <span class="nav-item-icon">&#x1F4C1;</span>
            <span>Groups</span>
          </div>
          <div class="nav-item" data-page="favorites">
            <span class="nav-item-icon">&#x2B50;</span>
            <span>Favorites</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Monitoring</div>
          <div class="nav-item" data-page="activity">
            <span class="nav-item-icon">&#x1F4DD;</span>
            <span>Activity Log</span>
          </div>
          <div class="nav-item" data-page="metrics">
            <span class="nav-item-icon">&#x1F4C8;</span>
            <span>Metrics</span>
          </div>
          <div class="nav-item" data-page="webhooks">
            <span class="nav-item-icon">&#x1F517;</span>
            <span>Webhooks</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Configuration</div>
          <div class="nav-item" data-page="settings">
            <span class="nav-item-icon">&#x2699;</span>
            <span>Settings</span>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="connection-status">
          <div class="status-indicator connected" id="sse-indicator"></div>
          <span id="sse-status">Real-time updates active</span>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <!-- API Key Banner -->
      <div class="api-key-banner hidden" id="api-key-banner">
        <span class="api-key-banner-icon">&#x1F511;</span>
        <span class="api-key-banner-text">Enter your API key to access all features</span>
        <input type="password" class="api-key-input" id="api-key-input" placeholder="Enter API key...">
        <button class="btn btn-primary" onclick="saveApiKey()">Connect</button>
        <button class="btn btn-secondary" onclick="hideApiKeyBanner()">Dismiss</button>
      </div>

      <header class="top-bar">
        <div style="display: flex; align-items: center; gap: 16px;">
          <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">&#x2630;</button>
          <div class="breadcrumb">
            <span>MCP Connect</span>
            <span class="breadcrumb-divider">/</span>
            <span class="breadcrumb-current" id="current-page">Dashboard</span>
          </div>
        </div>

        <div class="top-bar-actions">
          <input type="text" class="search-box" id="global-search" placeholder="Search servers, tools, templates... (Ctrl+K)">
          <div class="live-indicator">
            <div class="live-dot"></div>
            <span>LIVE</span>
          </div>

          <!-- Notifications -->
          <div class="notifications-wrapper">
            <button class="notifications-btn" onclick="toggleNotifications()" title="Notifications">
              &#x1F514;
              <span class="notification-badge hidden" id="notification-badge">0</span>
            </button>
            <div class="notifications-panel" id="notifications-panel">
              <div class="notifications-header">
                <span class="notifications-title">Notifications</span>
                <button class="notifications-clear" onclick="clearNotifications()">Clear all</button>
              </div>
              <div class="notifications-list" id="notifications-list">
                <div class="notification-item" style="justify-content: center; padding: 40px;">
                  <span style="color: var(--text-muted);">No notifications yet</span>
                </div>
              </div>
            </div>
          </div>

          <button class="btn btn-icon" onclick="refreshData()" title="Refresh">&#x21BB;</button>
          <button class="btn btn-icon" onclick="showApiKeyBanner()" title="API Key Settings">&#x1F511;</button>
          <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme" id="theme-toggle">&#x1F319;</button>
          <button class="btn btn-primary" onclick="showAddServerModal()">
            <span>+</span>
            <span>Add Server</span>
          </button>
        </div>
      </header>

      <div class="page-content" id="page-content">
        <!-- Dashboard page -->
        <div id="dashboard-page" class="page-container">
          <div class="page-header">
            <div>
              <h1 class="page-title">Dashboard</h1>
              <p class="page-subtitle">Monitor your MCP infrastructure at a glance</p>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">&#x26A1; Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions-grid">
                <button class="quick-action-btn" onclick="showAddServerModal()">
                  <span class="quick-action-icon">&#x2795;</span>
                  <span class="quick-action-label">Add Server</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('tools')">
                  <span class="quick-action-icon">&#x1F6E0;</span>
                  <span class="quick-action-label">Browse Tools</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('templates')">
                  <span class="quick-action-icon">&#x1F4CB;</span>
                  <span class="quick-action-label">Deploy Template</span>
                </button>
                <button class="quick-action-btn" onclick="exportConfig()">
                  <span class="quick-action-icon">&#x1F4E4;</span>
                  <span class="quick-action-label">Export Config</span>
                </button>
                <button class="quick-action-btn" onclick="showImportModal()">
                  <span class="quick-action-icon">&#x1F4E5;</span>
                  <span class="quick-action-label">Import Config</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('api-keys')">
                  <span class="quick-action-icon">&#x1F511;</span>
                  <span class="quick-action-label">Manage Keys</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('settings')">
                  <span class="quick-action-icon">&#x2699;</span>
                  <span class="quick-action-label">Settings</span>
                </button>
                <button class="quick-action-btn" onclick="refreshData()">
                  <span class="quick-action-icon">&#x1F504;</span>
                  <span class="quick-action-label">Refresh All</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon servers">&#x1F5A5;</div>
              </div>
              <div class="stat-card-value" id="stat-servers">-</div>
              <div class="stat-card-label">Connected Servers</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon tools">&#x1F6E0;</div>
              </div>
              <div class="stat-card-value" id="stat-tools">-</div>
              <div class="stat-card-label">Registered Tools</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon requests">&#x26A1;</div>
              </div>
              <div class="stat-card-value" id="stat-requests">-</div>
              <div class="stat-card-label">Requests Today</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon uptime">&#x23F1;</div>
              </div>
              <div class="stat-card-value" id="stat-uptime">-</div>
              <div class="stat-card-label">Uptime</div>
            </div>
          </div>

          <!-- Dashboard grid -->
          <div class="dashboard-grid">
            <!-- Requests chart -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">&#x1F4C8; Request Activity</h3>
                <div class="filters-bar" style="margin: 0;">
                  <button class="filter-chip active" data-range="1h">1H</button>
                  <button class="filter-chip" data-range="24h">24H</button>
                  <button class="filter-chip" data-range="7d">7D</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="requests-chart"></canvas>
              </div>
            </div>

            <!-- Activity feed -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">&#x1F4DD; Live Activity</h3>
              </div>
              <div class="card-body no-padding">
                <div class="activity-feed" id="activity-feed">
                  <div class="empty-state">
                    <div class="empty-state-icon">&#x1F4ED;</div>
                    <div class="empty-state-title">Waiting for events...</div>
                    <p>Real-time activity will appear here</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Circuit breakers -->
          <div class="card" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3 class="card-title">&#x1F50C; Circuit Breakers</h3>
            </div>
            <div class="card-body">
              <div class="circuit-breakers" id="circuit-breakers">
                <div class="empty-state">
                  <p>No circuit breakers configured</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick servers view -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">&#x1F5A5; Active Servers</h3>
              <button class="btn btn-secondary" onclick="showPage('servers')">View All</button>
            </div>
            <div class="card-body">
              <div class="servers-grid" id="quick-servers">
                <div class="empty-state">
                  <div class="spinner"></div>
                  <p style="margin-top: 12px;">Loading servers...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Servers page -->
        <div id="servers-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Servers</h1>
              <p class="page-subtitle">Manage your MCP server connections</p>
            </div>
            <button class="btn btn-primary" onclick="showAddServerModal()">+ Add Server</button>
          </div>
          <div class="servers-grid" id="servers-list">
            <div class="empty-state">
              <div class="spinner"></div>
              <p style="margin-top: 12px;">Loading servers...</p>
            </div>
          </div>
        </div>

        <!-- Tools page -->
        <div id="tools-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Tools</h1>
              <p class="page-subtitle">Browse all registered MCP tools</p>
            </div>
          </div>
          <div class="filters-bar">
            <input type="text" class="search-box" id="tools-search" placeholder="Search tools..." style="width: 300px;">
          </div>
          <div class="tools-grid" id="tools-list">
            <div class="empty-state">
              <div class="spinner"></div>
              <p style="margin-top: 12px;">Loading tools...</p>
            </div>
          </div>
        </div>

        <!-- Activity page -->
        <div id="activity-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Activity Log</h1>
              <p class="page-subtitle">Real-time event stream</p>
            </div>
          </div>
          <div class="card">
            <div class="card-body no-padding">
              <div class="activity-feed" id="activity-log" style="max-height: 600px;">
                <div class="empty-state">
                  <div class="empty-state-icon">&#x1F4ED;</div>
                  <div class="empty-state-title">No activity yet</div>
                  <p>Events will appear here in real-time</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Templates page -->
        <div id="templates-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Templates</h1>
              <p class="page-subtitle">Pre-configured MCP server templates ready to deploy</p>
            </div>
          </div>
          <div class="filters-bar">
            <button class="filter-chip active" data-category="all" onclick="filterTemplates('all')">All</button>
            <button class="filter-chip" data-category="storage" onclick="filterTemplates('storage')">Storage</button>
            <button class="filter-chip" data-category="database" onclick="filterTemplates('database')">Database</button>
            <button class="filter-chip" data-category="development" onclick="filterTemplates('development')">Development</button>
            <button class="filter-chip" data-category="communication" onclick="filterTemplates('communication')">Communication</button>
            <button class="filter-chip" data-category="ai" onclick="filterTemplates('ai')">AI</button>
          </div>
          <div class="tools-grid" id="templates-list">
            <div class="empty-state"><div class="spinner"></div><p style="margin-top: 12px;">Loading templates...</p></div>
          </div>
        </div>

        <!-- Groups page -->
        <div id="groups-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Groups</h1>
              <p class="page-subtitle">Organize servers into logical groups</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateGroupModal()">+ Create Group</button>
          </div>
          <div class="servers-grid" id="groups-list">
            <div class="empty-state">
              <div class="empty-state-icon">&#x1F4C1;</div>
              <div class="empty-state-title">No groups yet</div>
              <p>Create groups to organize your servers</p>
            </div>
          </div>
        </div>

        <!-- Favorites page -->
        <div id="favorites-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Favorites</h1>
              <p class="page-subtitle">Quick access to your favorite tools</p>
            </div>
          </div>
          <div class="tools-grid" id="favorites-list">
            <div class="empty-state">
              <div class="empty-state-icon">&#x2B50;</div>
              <div class="empty-state-title">No favorites yet</div>
              <p>Star tools from the Tools page to add them here</p>
            </div>
          </div>
        </div>

        <!-- Metrics page -->
        <div id="metrics-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Metrics</h1>
              <p class="page-subtitle">System performance and usage statistics</p>
            </div>
            <button class="btn btn-secondary" onclick="loadMetricsPage()">&#x21BB; Refresh</button>
          </div>
          <div class="stats-grid" id="metrics-stats">
            <div class="stat-card">
              <div class="stat-card-header"><div class="stat-card-icon requests">&#x1F4CA;</div></div>
              <div class="stat-card-value" id="metric-total-requests">-</div>
              <div class="stat-card-label">Total Requests</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header"><div class="stat-card-icon servers">&#x2705;</div></div>
              <div class="stat-card-value" id="metric-success-rate">-</div>
              <div class="stat-card-label">Success Rate</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header"><div class="stat-card-icon tools">&#x1F5A5;</div></div>
              <div class="stat-card-value" id="metric-active-servers">-</div>
              <div class="stat-card-label">Active Servers</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header"><div class="stat-card-icon uptime">&#x1F6E0;</div></div>
              <div class="stat-card-value" id="metric-total-tools">-</div>
              <div class="stat-card-label">Total Tools</div>
            </div>
          </div>
          <!-- Performance Charts -->
          <div class="metrics-chart-grid">
            <div class="card">
              <div class="card-header"><h3 class="card-title">&#x23F1; Response Times by Server</h3></div>
              <div class="chart-container">
                <canvas id="response-time-chart"></canvas>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">&#x1F4CA; Request Distribution</h3></div>
              <div class="chart-container">
                <canvas id="request-distribution-chart"></canvas>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <div class="card-header"><h3 class="card-title">&#x1F4C8; Top Endpoints</h3></div>
            <div class="card-body no-padding">
              <div id="top-endpoints-list" style="padding: 0;"></div>
            </div>
          </div>
          <div class="card" style="margin-top: 24px;">
            <div class="card-header"><h3 class="card-title">&#x1F5A5; Server Status</h3></div>
            <div class="card-body">
              <div class="servers-grid" id="metrics-servers-list"></div>
            </div>
          </div>
        </div>

        <!-- Webhooks page -->
        <div id="webhooks-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Webhooks</h1>
              <p class="page-subtitle">Subscribe to real-time events via webhooks</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateWebhookModal()">+ Add Webhook</button>
          </div>
          <div class="card">
            <div class="card-header"><h3 class="card-title">&#x1F4E1; Available Events</h3></div>
            <div class="card-body">
              <div class="tools-grid">
                <div class="tool-card">
                  <div class="tool-name">server.connected</div>
                  <div class="tool-description">Triggered when a server connects</div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">server.disconnected</div>
                  <div class="tool-description">Triggered when a server disconnects</div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">server.error</div>
                  <div class="tool-description">Triggered on server errors</div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">tool.invoked</div>
                  <div class="tool-description">Triggered when a tool is invoked</div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">tool.error</div>
                  <div class="tool-description">Triggered on tool invocation errors</div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">circuit.opened</div>
                  <div class="tool-description">Triggered when circuit breaker opens</div>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top: 24px;">
            <div class="card-header"><h3 class="card-title">&#x1F517; Subscriptions</h3></div>
            <div class="card-body">
              <div id="webhooks-list">
                <div class="empty-state">
                  <div class="empty-state-icon">&#x1F517;</div>
                  <div class="empty-state-title">No webhooks configured</div>
                  <p>Add a webhook to receive real-time event notifications</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resources Page -->
        <div id="resources-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Resources</h1>
              <p class="page-subtitle">Browse and read MCP server resources</p>
            </div>
            <div class="header-actions">
              <input type="text" class="search-box" id="resource-search" placeholder="Search resources..." style="width: 250px;">
              <button class="btn btn-secondary" onclick="loadResourcesPage()">Refresh</button>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div id="resources-list" class="tools-grid">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Prompts Page -->
        <div id="prompts-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Prompts</h1>
              <p class="page-subtitle">Browse and test MCP server prompts</p>
            </div>
            <div class="header-actions">
              <input type="text" class="search-box" id="prompt-search" placeholder="Search prompts..." style="width: 250px;">
              <button class="btn btn-secondary" onclick="loadPromptsPage()">Refresh</button>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div id="prompts-list" class="tools-grid">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- API Keys Page -->
        <div id="api-keys-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">API Keys</h1>
              <p class="page-subtitle">Manage API keys for accessing MCP Connect</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateApiKeyModal()">+ Create API Key</button>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">&#x1F511; Active API Keys</h3>
            </div>
            <div class="card-body">
              <div id="api-keys-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">&#x1F4DD; API Key Usage</h3>
            </div>
            <div class="card-body">
              <p style="color: var(--text-secondary); margin-bottom: 16px;">
                API keys are used to authenticate requests to MCP Connect. Include the key in the <code>Authorization</code> header:
              </p>
              <div class="result-output" style="margin-bottom: 16px;">
Authorization: Bearer YOUR_API_KEY</div>
              <p style="color: var(--text-muted); font-size: 13px;">
                Keys have permissions based on their scope. Store keys securely and rotate them regularly.
              </p>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="page-container" style="display: none;">
          <div class="page-header">
            <div>
              <h1 class="page-title">Settings</h1>
              <p class="page-subtitle">Configure MCP Connect and integrations</p>
            </div>
          </div>

          <!-- Docker MCP Settings -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">&#x1F40B; Docker MCP Gateway</h3>
              <span id="docker-status-badge" class="badge badge-muted">Checking...</span>
            </div>
            <div class="card-body">
              <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Configure secrets for Docker MCP Gateway integrations. These credentials enable GitHub, Firecrawl, and other providers.
              </p>
              <div id="docker-secrets-list">
                <div class="spinner" style="margin: 20px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Add Secret Form -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">&#x2795; Add/Update Secret</h3>
            </div>
            <div class="card-body">
              <form id="add-secret-form" onsubmit="handleAddSecret(event)">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 16px; align-items: end;">
                  <div class="form-group">
                    <label class="form-label">Secret Name</label>
                    <select class="form-select" id="secret-name-select">
                      <option value="">Select a secret...</option>
                      <option value="github.personal_access_token">github.personal_access_token</option>
                      <option value="firecrawl.api_key">firecrawl.api_key</option>
                      <option value="linear.api_key">linear.api_key</option>
                      <option value="notion.api_key">notion.api_key</option>
                      <option value="neon.api_key">neon.api_key</option>
                      <option value="custom">Custom...</option>
                    </select>
                    <input type="text" class="form-input" id="secret-name-custom" placeholder="Custom secret name" style="display: none; margin-top: 8px;">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Secret Value</label>
                    <input type="password" class="form-input" id="secret-value" placeholder="Enter secret value...">
                  </div>
                  <button type="submit" class="btn btn-primary">Set Secret</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Instructions -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">&#x1F4DD; Integration Setup</h3>
            </div>
            <div class="card-body">
              <div class="tools-grid">
                <div class="tool-card">
                  <div class="tool-name">GitHub</div>
                  <div class="tool-description">
                    Secret: <code>github.personal_access_token</code><br>
                    <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent-primary);">Create token</a> with repo, read:user scopes
                  </div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">Firecrawl</div>
                  <div class="tool-description">
                    Secret: <code>firecrawl.api_key</code><br>
                    <a href="https://firecrawl.dev" target="_blank" style="color: var(--accent-primary);">Get API key</a> from Firecrawl dashboard
                  </div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">Linear</div>
                  <div class="tool-description">
                    Secret: <code>linear.api_key</code><br>
                    <a href="https://linear.app/settings/api" target="_blank" style="color: var(--accent-primary);">Create API key</a> in Linear settings
                  </div>
                </div>
                <div class="tool-card">
                  <div class="tool-name">Neon</div>
                  <div class="tool-description">
                    Secret: <code>neon.api_key</code><br>
                    <a href="https://console.neon.tech/app/settings/api-keys" target="_blank" style="color: var(--accent-primary);">Create API key</a> in Neon console
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Modal overlay -->
  <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal" id="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Modal Title</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>

  <!-- Command palette -->
  <div class="command-palette" id="command-palette">
    <input type="text" class="command-input" id="command-input" placeholder="Type a command or search...">
    <div class="command-results" id="command-results"></div>
  </div>

  <script>
    // Global state
    const state = {
      servers: [],
      tools: [],
      activities: [],
      sseConnected: false,
      currentPage: 'dashboard',
      requestChart: null,
    };

    const API_BASE = '/api';
    let eventSource = null;

    // Get API key from localStorage (non-blocking)
    function getApiKey() {
      return localStorage.getItem('apiKey');
    }

    function getAuthHeaders() {
      const key = getApiKey();
      return key ? { 'Authorization': `Bearer ${key}` } : {};
    }

    function showApiKeyBanner() {
      const banner = document.getElementById('api-key-banner');
      const input = document.getElementById('api-key-input');
      const existingKey = getApiKey();

      // If key exists, show masked version
      if (existingKey) {
        input.placeholder = existingKey.substring(0, 12) + '...' + existingKey.slice(-4);
      } else {
        input.placeholder = 'Enter API key...';
      }
      input.value = '';
      banner.classList.remove('hidden');
    }

    function hideApiKeyBanner() {
      const banner = document.getElementById('api-key-banner');
      banner.classList.add('hidden');
    }

    function saveApiKey() {
      const input = document.getElementById('api-key-input');
      const key = input.value.trim();
      if (key) {
        localStorage.setItem('apiKey', key);
        hideApiKeyBanner();
        showToast('success', 'API key saved! Refreshing data...');
        // Reconnect SSE with new key
        connectSSE();
        // Refresh all data
        refreshData();
      } else {
        showToast('error', 'Please enter a valid API key');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      initializeNavigation();
      initializeSSE();
      initializeCharts();
      initializeSearch();

      // Show API key banner if no key stored
      if (!getApiKey()) {
        showApiKeyBanner();
      }

      // Handle Enter key on API key input
      document.getElementById('api-key-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveApiKey();
      });
    });

    async function initializeApp() {
      await Promise.all([
        fetchHealth(),
        fetchStats()
      ]);
    }

    // Navigation
    function initializeNavigation() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          if (page) showPage(page);
        });
      });
    }

    function showPage(pageName) {
      state.currentPage = pageName;

      // Update nav active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === pageName);
      });

      // Update breadcrumb
      document.getElementById('current-page').textContent =
        pageName.charAt(0).toUpperCase() + pageName.slice(1);

      // Hide all pages
      document.querySelectorAll('.page-container').forEach(page => {
        page.style.display = 'none';
      });

      // Show the selected page
      const pageMap = {
        'dashboard': 'dashboard-page',
        'servers': 'servers-page',
        'tools': 'tools-page',
        'resources': 'resources-page',
        'prompts': 'prompts-page',
        'activity': 'activity-page',
        'templates': 'templates-page',
        'api-keys': 'api-keys-page',
        'groups': 'groups-page',
        'favorites': 'favorites-page',
        'metrics': 'metrics-page',
        'webhooks': 'webhooks-page',
        'settings': 'settings-page'
      };

      const pageId = pageMap[pageName] || 'dashboard-page';
      const pageEl = document.getElementById(pageId);
      if (pageEl) {
        pageEl.style.display = 'block';
      }

      // Load page-specific data
      switch (pageName) {
        case 'servers': loadServersPage(); break;
        case 'tools': loadToolsPage(); break;
        case 'resources': loadResourcesPage(); break;
        case 'prompts': loadPromptsPage(); break;
        case 'templates': loadTemplatesPage(); break;
        case 'api-keys': loadApiKeysPage(); break;
        case 'groups': loadGroupsPage(); break;
        case 'favorites': loadFavoritesPage(); break;
        case 'activity': loadActivityPage(); break;
        case 'metrics': loadMetricsPage(); break;
        case 'webhooks': loadWebhooksPage(); break;
        case 'settings': loadSettingsPage(); break;
      }
    }

    // SSE Real-time updates
    function initializeSSE() {
      // Try to connect to SSE endpoint (requires auth in production)
      connectSSE();
    }

    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      const sseIndicator = document.getElementById('sse-indicator');
      const sseStatus = document.getElementById('sse-status');

      try {
        // SSE with API key authentication
        const apiKey = getApiKey();
        const sseUrl = apiKey ? `${API_BASE}/sse/events?api_key=${apiKey}` : `${API_BASE}/sse/events`;
        eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => {
          state.sseConnected = true;
          sseIndicator.className = 'status-indicator connected';
          sseStatus.textContent = 'Real-time updates active';
        };

        eventSource.onerror = () => {
          state.sseConnected = false;
          sseIndicator.className = 'status-indicator disconnected';
          sseStatus.textContent = 'Reconnecting...';

          // Fallback to polling
          setTimeout(connectSSE, 5000);
        };

        eventSource.addEventListener('connected', (e) => {
          const data = JSON.parse(e.data);
          console.log('SSE connected:', data);
        });

        eventSource.addEventListener('server.connected', (e) => {
          const data = JSON.parse(e.data);
          addActivity('connect', `Server connected: ${data.serverName}`, `${data.toolCount} tools registered`);
          showToast('success', `Connected to ${data.serverName}`);
          refreshData();
        });

        eventSource.addEventListener('server.disconnected', (e) => {
          const data = JSON.parse(e.data);
          addActivity('disconnect', `Server disconnected: ${data.serverName}`, 'Connection closed');
          showToast('warning', `Disconnected from ${data.serverName}`);
          refreshData();
        });

        eventSource.addEventListener('server.error', (e) => {
          const data = JSON.parse(e.data);
          addActivity('error', `Server error: ${data.serverName}`, data.error);
          showToast('error', `Error: ${data.serverName}`);
        });

        eventSource.addEventListener('tool.invoked', (e) => {
          const data = JSON.parse(e.data);
          addActivity('invoke', `Tool invoked: ${data.toolName}`, `Duration: ${data.durationMs}ms`);
        });

        eventSource.addEventListener('circuit.opened', (e) => {
          const data = JSON.parse(e.data);
          addActivity('error', `Circuit opened: ${data.serverName}`, 'Too many failures');
          showToast('error', `Circuit breaker opened for ${data.serverName}`);
        });

        eventSource.addEventListener('keepalive', () => {
          // Heartbeat received
        });

      } catch (error) {
        console.error('SSE connection failed:', error);
        sseIndicator.className = 'status-indicator disconnected';
        sseStatus.textContent = 'Connection unavailable';
      }
    }

    // Activity feed
    function addActivity(type, title, description) {
      const feed = document.getElementById('activity-feed');
      const now = new Date();

      // Remove empty state if present
      const emptyState = feed.querySelector('.empty-state');
      if (emptyState) {
        feed.innerHTML = '';
      }

      const iconMap = {
        connect: '&#x2705;',
        disconnect: '&#x1F534;',
        invoke: '&#x26A1;',
        error: '&#x26A0;'
      };

      const activityHtml = `
        <div class="activity-item">
          <div class="activity-icon ${type}">${iconMap[type] || '&#x1F4AC;'}</div>
          <div class="activity-content">
            <div class="activity-title">${title}</div>
            <div class="activity-description">${description}</div>
          </div>
          <div class="activity-time">${now.toLocaleTimeString()}</div>
        </div>
      `;

      feed.insertAdjacentHTML('afterbegin', activityHtml);

      // Keep only last 50 activities
      while (feed.children.length > 50) {
        feed.removeChild(feed.lastChild);
      }

      state.activities.unshift({ type, title, description, time: now });
    }

    // Charts
    function initializeCharts() {
      const ctx = document.getElementById('requests-chart');
      if (!ctx) return;

      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 280);
      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
      gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

      state.requestChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: generateTimeLabels(12),
          datasets: [{
            label: 'Requests',
            data: generateSampleData(12),
            fill: true,
            backgroundColor: gradient,
            borderColor: '#6366f1',
            borderWidth: 2,
            tension: 0.4,
            pointBackgroundColor: '#6366f1',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index',
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: '#1a1a24',
              titleColor: '#f4f4f5',
              bodyColor: '#a1a1aa',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255,255,255,0.05)',
              },
              ticks: {
                color: '#71717a',
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255,255,255,0.05)',
              },
              ticks: {
                color: '#71717a',
              }
            }
          }
        }
      });

      // Time range filters
      document.querySelectorAll('.filter-chip[data-range]').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip[data-range]').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          updateChartRange(chip.dataset.range);
        });
      });
    }

    function generateTimeLabels(count) {
      const labels = [];
      const now = new Date();
      for (let i = count - 1; i >= 0; i--) {
        const time = new Date(now - i * 5 * 60 * 1000);
        labels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
      }
      return labels;
    }

    function generateSampleData(count) {
      return Array.from({ length: count }, () => Math.floor(Math.random() * 100) + 20);
    }

    function updateChartRange(range) {
      if (!state.requestChart) return;

      let count;
      switch (range) {
        case '1h': count = 12; break;
        case '24h': count = 24; break;
        case '7d': count = 7; break;
        default: count = 12;
      }

      state.requestChart.data.labels = generateTimeLabels(count);
      state.requestChart.data.datasets[0].data = generateSampleData(count);
      state.requestChart.update();
    }

    // Search
    function initializeSearch() {
      const searchBox = document.getElementById('global-search');

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchBox.focus();
        }
        if (e.key === 'Escape') {
          searchBox.blur();
        }
      });

      searchBox.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        // Implement search logic here
      });
    }

    // API calls
    async function fetchHealth() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const json = await res.json();

        if (json.success) {
          const data = json.data;
          document.getElementById('stat-servers').textContent = data.servers?.connected || 0;
          document.getElementById('stat-tools').textContent = data.tools?.registered || 0;
          document.getElementById('stat-uptime').textContent = formatUptime(data.uptime);
          document.getElementById('version').textContent = `v${data.version}`;

          // Update nav badges
          document.getElementById('nav-server-count').textContent = data.servers?.total || 0;
          document.getElementById('nav-tool-count').textContent = data.tools?.registered || 0;
        }
      } catch (err) {
        console.error('Failed to fetch health:', err);
      }
    }

    async function fetchStats() {
      try {
        const res = await fetch(`${API_BASE}/monitor/stats`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            document.getElementById('stat-requests').textContent = json.data.totalRequests || '0';
          }
        }
      } catch (err) {
        // Stats endpoint may require auth, use fallback
        document.getElementById('stat-requests').textContent = '0';
      }

      // Fetch and render servers
      await fetchServers();
    }

    async function fetchServers() {
      try {
        const res = await fetch(`${API_BASE}/servers`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            state.servers = json.data;
            renderServers(json.data.map(s => ({
              name: s.name,
              category: s.metadata?.category || 'General',
              status: s.connectionStatus,
              toolCount: s.toolCount || 0,
              resourceCount: s.resourceCount || 0,
              requests: 0
            })));
          }
        }
      } catch (err) {
        console.error('Failed to fetch servers:', err);
        renderServers([]);
      }
    }

    function renderServers(servers) {
      const container = document.getElementById('quick-servers');

      if (!servers || servers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F5A5;</div>
            <div class="empty-state-title">No servers connected</div>
            <p>Add a server to get started</p>
          </div>
        `;
        return;
      }

      container.innerHTML = servers.map(server => `
        <div class="server-card">
          <div class="server-card-header">
            <div class="server-icon">${getServerIcon(server.name)}</div>
            <div class="server-info">
              <div class="server-name">${server.name}</div>
              <div class="server-category">${server.category || 'General'}</div>
            </div>
            <div class="server-status-badge ${server.status || 'disconnected'}">
              ${server.status || 'Disconnected'}
            </div>
          </div>
          <div class="server-stats">
            <div class="server-stat">
              <div class="server-stat-value">${server.toolCount || 0}</div>
              <div class="server-stat-label">Tools</div>
            </div>
            <div class="server-stat">
              <div class="server-stat-value">${server.resourceCount || 0}</div>
              <div class="server-stat-label">Resources</div>
            </div>
            <div class="server-stat">
              <div class="server-stat-value">${server.requests || 0}</div>
              <div class="server-stat-label">Requests</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getServerIcon(name) {
      const icons = {
        filesystem: '&#x1F4C1;',
        memory: '&#x1F9E0;',
        github: '&#x1F419;',
        postgres: '&#x1F418;',
        slack: '&#x1F4AC;',
        default: '&#x1F5A5;'
      };
      const key = Object.keys(icons).find(k => name.toLowerCase().includes(k));
      return icons[key] || icons.default;
    }

    // Utility functions
    function formatUptime(seconds) {
      if (!seconds) return '-';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);

      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      return `${minutes}m`;
    }

    function refreshData() {
      fetchHealth();
      fetchStats();
    }

    // Toast notifications
    function showToast(type, message) {
      const container = document.getElementById('toast-container');

      const icons = {
        success: '&#x2705;',
        error: '&#x274C;',
        warning: '&#x26A0;',
        info: '&#x2139;'
      };

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(toast);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    // Modal functions (placeholder)
    function showAddServerModal() {
      showToast('info', 'Server creation requires API authentication');
    }

    // Page loaders
    async function loadServersPage() {
      const container = document.getElementById('servers-list');
      try {
        const res = await fetch(`${API_BASE}/servers`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            renderServersPage(json.data);
          }
        }
      } catch (err) {
        console.error('Failed to load servers:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load servers</p></div>';
      }
    }

    function renderServersPage(servers) {
      const container = document.getElementById('servers-list');
      if (!servers || servers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F5A5;</div>
            <div class="empty-state-title">No servers configured</div>
            <p>Add a server to get started</p>
          </div>
        `;
        return;
      }

      container.innerHTML = servers.map(server => `
        <div class="server-card">
          <div class="server-card-header">
            <div class="server-icon">${getServerIcon(server.name)}</div>
            <div class="server-info">
              <div class="server-name">${server.name}</div>
              <div class="server-category">${server.metadata?.category || 'General'}</div>
            </div>
            <div class="server-status-badge ${server.connectionStatus || 'disconnected'}">
              ${server.connectionStatus || 'Disconnected'}
            </div>
          </div>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
            ${server.description || 'No description'}
          </p>
          <div class="server-stats">
            <div class="server-stat">
              <div class="server-stat-value">${server.toolCount || 0}</div>
              <div class="server-stat-label">Tools</div>
            </div>
            <div class="server-stat">
              <div class="server-stat-value">${server.transport?.type || '-'}</div>
              <div class="server-stat-label">Transport</div>
            </div>
            <div class="server-stat">
              <div class="server-stat-value">${server.enabled ? 'Yes' : 'No'}</div>
              <div class="server-stat-label">Enabled</div>
            </div>
          </div>
          <div class="server-actions">
            ${server.connectionStatus === 'connected'
              ? `<button class="btn btn-secondary" onclick="disconnectServer('${server.id}')">Disconnect</button>`
              : `<button class="btn btn-primary" onclick="connectServer('${server.id}')">Connect</button>`
            }
          </div>
        </div>
      `).join('');
    }

    async function connectServer(serverId) {
      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}/connect`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          showToast('success', 'Server connected');
          loadServersPage();
          fetchHealth();
        } else {
          showToast('error', 'Failed to connect server');
        }
      } catch (err) {
        showToast('error', 'Connection error');
      }
    }

    async function disconnectServer(serverId) {
      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}/disconnect`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          showToast('success', 'Server disconnected');
          loadServersPage();
          fetchHealth();
        } else {
          showToast('error', 'Failed to disconnect server');
        }
      } catch (err) {
        showToast('error', 'Disconnection error');
      }
    }

    async function loadToolsPage() {
      const container = document.getElementById('tools-list');
      try {
        const res = await fetch(`${API_BASE}/tools`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            // API returns {tools: [...]} not a direct array
            const tools = json.data.tools || json.data;
            state.tools = tools;
            renderToolsPage(tools);
            initToolsSearch();
          }
        } else {
          container.innerHTML = '<div class="empty-state"><p>Authentication required to view tools</p></div>';
        }
      } catch (err) {
        console.error('Failed to load tools:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load tools</p></div>';
      }
    }

    function renderToolsPage(tools) {
      const container = document.getElementById('tools-list');
      if (!tools || tools.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F6E0;</div>
            <div class="empty-state-title">No tools registered</div>
            <p>Connect a server to see available tools</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tools.map(tool => `
        <div class="tool-card" data-tool-name="${tool.name.toLowerCase()}" data-tool-schema='${JSON.stringify(tool.inputSchema || {}).replace(/'/g, "&#39;")}' onclick="showToolInvocationModal('${tool.name}', JSON.parse(this.dataset.toolSchema))">
          <div class="tool-name">${tool.name}</div>
          <div class="tool-description">${tool.description || 'No description'}</div>
          <div class="tool-meta">
            <span class="tool-tag">${tool.serverName || 'Unknown'}</span>
            ${tool.inputSchema?.required?.length ? `<span class="tool-tag">${tool.inputSchema.required.length} params</span>` : ''}
            <span class="tool-tag" style="background: var(--accent-primary); color: white;">&#x25B6; Run</span>
          </div>
        </div>
      `).join('');
    }

    function initToolsSearch() {
      const searchInput = document.getElementById('tools-search');
      if (searchInput) {
        searchInput.oninput = (e) => {
          const query = e.target.value.toLowerCase();
          document.querySelectorAll('.tool-card').forEach(card => {
            const name = card.dataset.toolName || '';
            card.style.display = name.includes(query) ? 'block' : 'none';
          });
        };
      }
    }

    // Templates page
    let allTemplates = [];
    async function loadTemplatesPage() {
      const container = document.getElementById('templates-list');
      try {
        const res = await fetch(`${API_BASE}/templates`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            allTemplates = json.data.templates || [];
            renderTemplates(allTemplates);
          }
        }
      } catch (err) {
        console.error('Failed to load templates:', err);
        container.innerHTML = '<div class="empty-state"><p>Failed to load templates</p></div>';
      }
    }

    function renderTemplates(templates) {
      const container = document.getElementById('templates-list');
      if (!templates || templates.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#x1F4CB;</div><div class="empty-state-title">No templates available</div></div>';
        return;
      }

      const iconMap = {
        'folder': '&#x1F4C1;', 'database': '&#x1F4BE;', 'github': '&#x1F419;',
        'message-square': '&#x1F4AC;', 'cloud': '&#x2601;', 'search': '&#x1F50D;',
        'globe': '&#x1F310;', 'monitor': '&#x1F5A5;', 'image': '&#x1F5BC;',
        'brain': '&#x1F9E0;', 'check-square': '&#x2705;', 'file-text': '&#x1F4C4;',
        'message-circle': '&#x1F4AC;', 'alert-circle': '&#x26A0;', 'git-branch': '&#x1F500;',
        'clock': '&#x1F552;', 'box': '&#x1F4E6;', 'server': '&#x1F5A5;', 'table': '&#x1F4CA;',
        'phone': '&#x1F4DE;', 'mail': '&#x1F4E7;', 'credit-card': '&#x1F4B3;', 'alert-triangle': '&#x26A0;'
      };

      container.innerHTML = templates.map(t => `
        <div class="tool-card" data-category="${t.category}" onclick="deployTemplate('${t.id}')">
          <div class="tool-name">${iconMap[t.icon] || '&#x1F4E6;'} ${t.name}</div>
          <div class="tool-description">${t.description || 'No description'}</div>
          <div class="tool-meta">
            <span class="tool-tag">${t.category}</span>
            ${t.isBuiltIn ? '<span class="tool-tag">Built-in</span>' : ''}
          </div>
        </div>
      `).join('');
    }

    function filterTemplates(category) {
      document.querySelectorAll('.filter-chip[data-category]').forEach(c =>
        c.classList.toggle('active', c.dataset.category === category));

      if (category === 'all') {
        renderTemplates(allTemplates);
      } else {
        renderTemplates(allTemplates.filter(t => t.category === category));
      }
    }

    function deployTemplate(templateId) {
      showToast('info', 'Template deployment coming soon! Use API to deploy.');
    }

    // Groups page
    async function loadGroupsPage() {
      const container = document.getElementById('groups-list');
      try {
        const res = await fetch(`${API_BASE}/groups`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data && json.data.length > 0) {
            renderGroups(json.data);
          } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#x1F4C1;</div><div class="empty-state-title">No groups yet</div><p>Create groups to organize your servers</p></div>';
          }
        }
      } catch (err) {
        console.error('Failed to load groups:', err);
      }
    }

    function renderGroups(groups) {
      const container = document.getElementById('groups-list');
      container.innerHTML = groups.map(g => `
        <div class="server-card">
          <div class="server-card-header">
            <div class="server-icon">&#x1F4C1;</div>
            <div class="server-info">
              <div class="server-name">${g.name}</div>
              <div class="server-category">${g.description || 'No description'}</div>
            </div>
          </div>
          <div class="server-stats">
            <div class="server-stat">
              <div class="server-stat-value">${g.serverCount || 0}</div>
              <div class="server-stat-label">Servers</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showCreateGroupModal() {
      showToast('info', 'Group creation available via API');
    }

    // Favorites page
    async function loadFavoritesPage() {
      const container = document.getElementById('favorites-list');
      try {
        const res = await fetch(`${API_BASE}/favorites`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data?.favorites?.length > 0) {
            renderFavorites(json.data.favorites);
          } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#x2B50;</div><div class="empty-state-title">No favorites yet</div><p>Star tools from the Tools page to add them here</p></div>';
          }
        }
      } catch (err) {
        console.error('Failed to load favorites:', err);
      }
    }

    function renderFavorites(favorites) {
      const container = document.getElementById('favorites-list');
      container.innerHTML = favorites.map(f => `
        <div class="tool-card">
          <div class="tool-name">&#x2B50; ${f.toolName}</div>
          <div class="tool-description">${f.description || 'No description'}</div>
          <div class="tool-meta">
            <span class="tool-tag">${f.serverName || 'Unknown'}</span>
          </div>
        </div>
      `).join('');
    }

    // Metrics page
    async function loadMetricsPage() {
      try {
        const res = await fetch(`${API_BASE}/monitor/stats`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            renderMetrics(json.data);
          }
        }
      } catch (err) {
        console.error('Failed to load metrics:', err);
      }
    }

    function renderMetrics(data) {
      // Calculate totals
      const totalRequests = Object.values(data.endpoints?.byPath || {}).reduce((a, b) => a + b, 0);
      const successCount = data.endpoints?.byStatus?.['200'] || 0;
      const successRate = totalRequests > 0 ? Math.round((successCount / totalRequests) * 100) : 0;
      const activeServers = data.servers?.filter(s => s.status === 'connected').length || 0;
      const totalTools = data.servers?.reduce((a, s) => a + (s.toolCount || 0), 0) || 0;

      document.getElementById('metric-total-requests').textContent = totalRequests;
      document.getElementById('metric-success-rate').textContent = successRate + '%';
      document.getElementById('metric-active-servers').textContent = activeServers;
      document.getElementById('metric-total-tools').textContent = totalTools;

      // Top endpoints
      const endpointsList = document.getElementById('top-endpoints-list');
      if (data.topEndpoints?.length > 0) {
        endpointsList.innerHTML = data.topEndpoints.map(e => `
          <div class="activity-item">
            <div class="activity-content">
              <div class="activity-title" style="font-family: monospace;">${e.path}</div>
            </div>
            <div class="activity-time">${e.count} requests</div>
          </div>
        `).join('');
      } else {
        endpointsList.innerHTML = '<div class="empty-state"><p>No endpoint data yet</p></div>';
      }

      // Server status
      const serversContainer = document.getElementById('metrics-servers-list');
      if (data.servers?.length > 0) {
        serversContainer.innerHTML = data.servers.map(s => `
          <div class="server-card">
            <div class="server-card-header">
              <div class="server-icon">${getServerIcon(s.name)}</div>
              <div class="server-info">
                <div class="server-name">${s.name}</div>
                <div class="server-category">${s.category || 'General'}</div>
              </div>
              <div class="server-status-badge ${s.status}">${s.status}</div>
            </div>
            <div class="server-stats">
              <div class="server-stat">
                <div class="server-stat-value">${s.toolCount || 0}</div>
                <div class="server-stat-label">Tools</div>
              </div>
              <div class="server-stat">
                <div class="server-stat-value">${s.rateLimit?.requestsPerMinute || '-'}</div>
                <div class="server-stat-label">Rate/min</div>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // Webhooks page
    async function loadWebhooksPage() {
      try {
        const res = await fetch(`${API_BASE}/webhooks/subscriptions`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data?.subscriptions?.length > 0) {
            renderWebhooks(json.data.subscriptions);
          }
        }
      } catch (err) {
        console.error('Failed to load webhooks:', err);
      }
    }

    function renderWebhooks(webhooks) {
      const container = document.getElementById('webhooks-list');
      container.innerHTML = webhooks.map(w => `
        <div class="activity-item">
          <div class="activity-icon connect">&#x1F517;</div>
          <div class="activity-content">
            <div class="activity-title">${w.url}</div>
            <div class="activity-description">Events: ${w.events?.join(', ') || 'All'}</div>
          </div>
          <div class="activity-time">${w.active ? 'Active' : 'Inactive'}</div>
        </div>
      `).join('');
    }

    function showCreateWebhookModal() {
      openModal('Create Webhook', `
        <div class="form-group">
          <label class="form-label">Webhook URL</label>
          <input type="url" class="form-input" id="webhook-url" placeholder="https://your-server.com/webhook">
          <div class="form-hint">The URL that will receive event notifications</div>
        </div>
        <div class="form-group">
          <label class="form-label">Events</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="server.connected" class="webhook-event"> server.connected
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="server.disconnected" class="webhook-event"> server.disconnected
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="tool.invoked" class="webhook-event"> tool.invoked
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="tool.error" class="webhook-event"> tool.error
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Secret (optional)</label>
          <input type="text" class="form-input" id="webhook-secret" placeholder="webhook-secret-key">
          <div class="form-hint">Used to sign webhook payloads for verification</div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createWebhook()">Create Webhook</button>
      `);
    }

    async function createWebhook() {
      const url = document.getElementById('webhook-url').value;
      const secret = document.getElementById('webhook-secret').value;
      const events = Array.from(document.querySelectorAll('.webhook-event:checked')).map(e => e.value);

      if (!url) {
        showToast('error', 'Please enter a webhook URL');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/webhooks/subscriptions`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, events, secret: secret || undefined })
        });

        if (res.ok) {
          showToast('success', 'Webhook created successfully');
          closeModal();
          loadWebhooksPage();
        } else {
          const json = await res.json();
          showToast('error', json.error || 'Failed to create webhook');
        }
      } catch (err) {
        showToast('error', 'Failed to create webhook');
      }
    }

    // Settings page - Docker MCP configuration
    async function loadSettingsPage() {
      // Check Docker status
      try {
        const statusRes = await fetch(`${API_BASE}/docker/status`, { headers: getAuthHeaders() });
        const statusJson = await statusRes.json();
        const badge = document.getElementById('docker-status-badge');

        if (statusJson.success && statusJson.data?.available) {
          badge.textContent = `v${statusJson.data.version || 'unknown'}`;
          badge.className = 'badge badge-success';
          loadDockerSecrets();
        } else {
          badge.textContent = 'Not Available';
          badge.className = 'badge badge-error';
          document.getElementById('docker-secrets-list').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">&#x1F40B;</div>
              <div class="empty-state-title">Docker MCP not available</div>
              <p>Install Docker Desktop with MCP support to configure integrations</p>
            </div>
          `;
        }
      } catch (err) {
        console.error('Failed to check Docker status:', err);
        document.getElementById('docker-status-badge').textContent = 'Error';
        document.getElementById('docker-status-badge').className = 'badge badge-error';
      }

      // Setup secret name select handler
      document.getElementById('secret-name-select')?.addEventListener('change', (e) => {
        const customInput = document.getElementById('secret-name-custom');
        if (e.target.value === 'custom') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
        }
      });
    }

    async function loadDockerSecrets() {
      try {
        const res = await fetch(`${API_BASE}/docker/secrets`, { headers: getAuthHeaders() });
        const json = await res.json();

        if (json.success && json.data?.secrets) {
          renderDockerSecrets(json.data.secrets);
        }
      } catch (err) {
        console.error('Failed to load Docker secrets:', err);
      }
    }

    function renderDockerSecrets(secrets) {
      const container = document.getElementById('docker-secrets-list');

      if (!secrets || secrets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F511;</div>
            <div class="empty-state-title">No secrets configured</div>
            <p>Add secrets to enable Docker MCP integrations</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Secret Name</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${secrets.map(s => `
                <tr>
                  <td><code>${s.name}</code></td>
                  <td>
                    <span class="badge ${s.configured ? 'badge-success' : 'badge-muted'}">
                      ${s.configured ? 'Configured' : 'Not Set'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="promptUpdateSecret('${s.name}')">Update</button>
                    ${s.configured ? `<button class="btn btn-sm btn-error" onclick="deleteDockerSecret('${s.name}')">Remove</button>` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function promptUpdateSecret(name) {
      document.getElementById('secret-name-select').value = name;
      document.getElementById('secret-name-custom').style.display = 'none';
      document.getElementById('secret-value').focus();
    }

    async function handleAddSecret(event) {
      event.preventDefault();

      const select = document.getElementById('secret-name-select');
      const customName = document.getElementById('secret-name-custom');
      const valueInput = document.getElementById('secret-value');

      const name = select.value === 'custom' ? customName.value : select.value;
      const value = valueInput.value;

      if (!name) {
        showToast('error', 'Please select or enter a secret name');
        return;
      }

      if (!value) {
        showToast('error', 'Please enter a secret value');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/docker/secrets`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, value })
        });

        const json = await res.json();

        if (json.success) {
          showToast('success', `Secret '${name}' configured. Restart Docker MCP Gateway for changes to take effect.`);
          valueInput.value = '';
          select.value = '';
          customName.value = '';
          customName.style.display = 'none';
          loadDockerSecrets();

          // Offer to reconnect Docker MCP Gateway
          if (confirm('Would you like to reconnect Docker MCP Gateway now to apply the changes?')) {
            await reconnectDockerGateway();
          }
        } else {
          showToast('error', json.error || 'Failed to set secret');
        }
      } catch (err) {
        showToast('error', 'Failed to set secret');
      }
    }

    async function deleteDockerSecret(name) {
      if (!confirm(`Are you sure you want to remove the secret '${name}'?`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/docker/secrets/${encodeURIComponent(name)}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        const json = await res.json();

        if (json.success) {
          showToast('success', `Secret '${name}' removed`);
          loadDockerSecrets();
        } else {
          showToast('error', json.error || 'Failed to remove secret');
        }
      } catch (err) {
        showToast('error', 'Failed to remove secret');
      }
    }

    async function reconnectDockerGateway() {
      // Find Docker MCP Gateway server
      try {
        const serversRes = await fetch(`${API_BASE}/servers`, { headers: getAuthHeaders() });
        const serversJson = await serversRes.json();

        if (serversJson.success && serversJson.data) {
          const dockerServer = serversJson.data.find(s => s.name === 'docker-mcp-gateway');
          if (dockerServer) {
            showToast('info', 'Reconnecting Docker MCP Gateway...');

            // Disconnect
            await fetch(`${API_BASE}/servers/${dockerServer.id}/disconnect`, {
              method: 'POST',
              headers: getAuthHeaders()
            });

            // Reconnect
            const connectRes = await fetch(`${API_BASE}/servers/${dockerServer.id}/connect`, {
              method: 'POST',
              headers: getAuthHeaders()
            });

            const connectJson = await connectRes.json();
            if (connectJson.success) {
              showToast('success', `Docker MCP Gateway reconnected with ${connectJson.data.tools?.length || 0} tools`);
              refreshData();
            } else {
              showToast('error', 'Failed to reconnect Docker MCP Gateway');
            }
          }
        }
      } catch (err) {
        showToast('error', 'Failed to reconnect Docker MCP Gateway');
      }
    }

    // ========================================
    // Resources Page
    // ========================================
    async function loadResourcesPage() {
      try {
        const res = await fetch(`${API_BASE}/resources`, { headers: getAuthHeaders() });
        const json = await res.json();

        if (json.success && json.data?.resources) {
          renderResources(json.data.resources);
          document.getElementById('nav-resource-count').textContent = json.data.resources.length;
        }
      } catch (err) {
        console.error('Failed to load resources:', err);
        document.getElementById('resources-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4C2;</div>
            <div class="empty-state-title">Unable to load resources</div>
            <p>Check that servers are connected</p>
          </div>
        `;
      }
    }

    function renderResources(resources) {
      const container = document.getElementById('resources-list');

      if (!resources || resources.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4C2;</div>
            <div class="empty-state-title">No resources available</div>
            <p>Connected servers haven't exposed any resources</p>
          </div>
        `;
        return;
      }

      container.innerHTML = resources.map(r => `
        <div class="tool-card" onclick="showResourceModal('${encodeURIComponent(r.uri)}', '${encodeURIComponent(r.name)}', '${r.serverId}')">
          <div class="tool-header">
            <span class="tool-name">${r.name}</span>
            <span class="badge badge-muted">${r.serverName || 'Unknown'}</span>
          </div>
          <div class="tool-description">${r.description || 'No description'}</div>
          <div class="tool-meta">
            <span class="tool-server">URI: ${r.uri}</span>
          </div>
          ${r.mimeType ? `<span class="badge badge-success" style="margin-top: 8px;">${r.mimeType}</span>` : ''}
        </div>
      `).join('');
    }

    async function showResourceModal(uri, name, serverId) {
      openModal(`Resource: ${decodeURIComponent(name)}`, `
        <div class="spinner" style="margin: 40px auto;"></div>
      `, '');

      try {
        const res = await fetch(`${API_BASE}/resources/${serverId}/${encodeURIComponent(decodeURIComponent(uri))}`, {
          headers: getAuthHeaders()
        });
        const json = await res.json();

        if (json.success && json.data) {
          const content = json.data.contents?.[0]?.text || JSON.stringify(json.data, null, 2);
          document.getElementById('modal-body').innerHTML = `
            <div class="form-group">
              <label class="form-label">URI</label>
              <div class="result-output">${decodeURIComponent(uri)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Content</label>
              <div class="result-output" style="max-height: 400px;">${escapeHtml(content)}</div>
            </div>
          `;
          document.getElementById('modal-footer').innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="copyToClipboard(this, '${encodeURIComponent(content)}')">Copy Content</button>
          `;
        } else {
          document.getElementById('modal-body').innerHTML = `
            <div class="alert alert-warning">Failed to read resource: ${json.error || 'Unknown error'}</div>
          `;
        }
      } catch (err) {
        document.getElementById('modal-body').innerHTML = `
          <div class="alert alert-warning">Failed to read resource</div>
        `;
      }
    }

    // ========================================
    // Prompts Page
    // ========================================
    async function loadPromptsPage() {
      try {
        const res = await fetch(`${API_BASE}/prompts`, { headers: getAuthHeaders() });
        const json = await res.json();

        if (json.success && json.data?.prompts) {
          renderPrompts(json.data.prompts);
          document.getElementById('nav-prompt-count').textContent = json.data.prompts.length;
        }
      } catch (err) {
        console.error('Failed to load prompts:', err);
        document.getElementById('prompts-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4AC;</div>
            <div class="empty-state-title">Unable to load prompts</div>
            <p>Check that servers are connected</p>
          </div>
        `;
      }
    }

    function renderPrompts(prompts) {
      const container = document.getElementById('prompts-list');

      if (!prompts || prompts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4AC;</div>
            <div class="empty-state-title">No prompts available</div>
            <p>Connected servers haven't exposed any prompts</p>
          </div>
        `;
        return;
      }

      container.innerHTML = prompts.map(p => `
        <div class="tool-card" onclick="showPromptModal('${encodeURIComponent(p.name)}', '${p.serverId}', ${JSON.stringify(p.arguments || []).replace(/"/g, '&quot;')})">
          <div class="tool-header">
            <span class="tool-name">${p.name}</span>
            <span class="badge badge-muted">${p.serverName || 'Unknown'}</span>
          </div>
          <div class="tool-description">${p.description || 'No description'}</div>
          ${p.arguments?.length > 0 ? `
            <div class="tool-meta" style="margin-top: 8px;">
              <span style="color: var(--text-muted);">Arguments: ${p.arguments.map(a => a.name).join(', ')}</span>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function showPromptModal(name, serverId, args) {
      const argsHtml = args && args.length > 0 ? args.map(arg => `
        <div class="form-group">
          <label class="form-label">${arg.name} ${arg.required ? '<span style="color: var(--error);">*</span>' : ''}</label>
          <input type="text" class="form-input" id="prompt-arg-${arg.name}" placeholder="${arg.description || ''}">
        </div>
      `).join('') : '<p style="color: var(--text-muted);">This prompt has no arguments</p>';

      openModal(`Prompt: ${decodeURIComponent(name)}`, `
        <form id="prompt-form">
          ${argsHtml}
        </form>
        <div id="prompt-result"></div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="executePrompt('${name}', '${serverId}')">Get Prompt</button>
      `);
    }

    async function executePrompt(name, serverId) {
      const resultDiv = document.getElementById('prompt-result');
      resultDiv.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';

      const form = document.getElementById('prompt-form');
      const args = {};
      form.querySelectorAll('input').forEach(el => {
        const key = el.id.replace('prompt-arg-', '');
        if (el.value) args[key] = el.value;
      });

      try {
        const res = await fetch(`${API_BASE}/prompts/${serverId}/${encodeURIComponent(decodeURIComponent(name))}`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ arguments: args })
        });

        const json = await res.json();

        if (json.success && json.data) {
          const messages = json.data.messages || [];
          resultDiv.innerHTML = `
            <div class="result-container">
              <div class="result-header">
                <div class="result-status success">&#x2705; Prompt Generated</div>
              </div>
              <div class="result-output">${messages.map(m => `[${m.role}]: ${m.content?.text || JSON.stringify(m.content)}`).join('\n\n')}</div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="result-container">
              <div class="result-status error">&#x274C; Error</div>
              <div class="result-output">${json.error || 'Failed to get prompt'}</div>
            </div>
          `;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="result-status error">&#x274C; ${err.message}</div>`;
      }
    }

    // ========================================
    // API Keys Page
    // ========================================
    async function loadApiKeysPage() {
      try {
        const res = await fetch(`${API_BASE}/keys`, { headers: getAuthHeaders() });
        const json = await res.json();

        if (json.success && json.data?.keys) {
          renderApiKeys(json.data.keys);
        }
      } catch (err) {
        console.error('Failed to load API keys:', err);
        document.getElementById('api-keys-list').innerHTML = `
          <div class="alert alert-warning">
            API key management requires master key authentication.
          </div>
        `;
      }
    }

    function renderApiKeys(keys) {
      const container = document.getElementById('api-keys-list');

      if (!keys || keys.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F511;</div>
            <div class="empty-state-title">No API keys</div>
            <p>Create an API key to get started</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Key Prefix</th>
                <th>Scopes</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${keys.map(k => `
                <tr>
                  <td><strong>${k.name}</strong></td>
                  <td><code>${k.keyPrefix}...</code></td>
                  <td>${(k.scopes || ['*']).map(s => `<span class="badge badge-muted">${s}</span>`).join(' ')}</td>
                  <td>${new Date(k.createdAt).toLocaleDateString()}</td>
                  <td>${k.lastUsedAt ? new Date(k.lastUsedAt).toLocaleDateString() : 'Never'}</td>
                  <td>
                    <button class="btn btn-sm btn-error" onclick="revokeApiKey('${k.id}')">Revoke</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function showCreateApiKeyModal() {
      openModal('Create API Key', `
        <div class="form-group">
          <label class="form-label">Key Name</label>
          <input type="text" class="form-input" id="api-key-name" placeholder="e.g., Production Key">
          <div class="form-hint">A descriptive name for this API key</div>
        </div>
        <div class="form-group">
          <label class="form-label">Scopes</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="*" class="api-key-scope" checked> All (*)
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="tools:read" class="api-key-scope"> tools:read
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="tools:invoke" class="api-key-scope"> tools:invoke
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="servers:read" class="api-key-scope"> servers:read
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="servers:write" class="api-key-scope"> servers:write
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Expires In</label>
          <select class="form-select" id="api-key-expiry">
            <option value="">Never</option>
            <option value="7">7 days</option>
            <option value="30">30 days</option>
            <option value="90">90 days</option>
            <option value="365">1 year</option>
          </select>
        </div>
        <div id="new-api-key-result"></div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createApiKey()">Create Key</button>
      `);
    }

    async function createApiKey() {
      const name = document.getElementById('api-key-name').value;
      const scopes = Array.from(document.querySelectorAll('.api-key-scope:checked')).map(e => e.value);
      const expiryDays = document.getElementById('api-key-expiry').value;

      if (!name) {
        showToast('error', 'Please enter a key name');
        return;
      }

      try {
        const body = { name, scopes };
        if (expiryDays) {
          body.expiresAt = new Date(Date.now() + parseInt(expiryDays) * 24 * 60 * 60 * 1000).toISOString();
        }

        const res = await fetch(`${API_BASE}/keys`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const json = await res.json();

        if (json.success && json.data?.key) {
          document.getElementById('new-api-key-result').innerHTML = `
            <div class="alert alert-warning" style="margin-top: 16px;">
              <strong>Save this key now!</strong> It won't be shown again.
              <div class="result-output" style="margin-top: 8px; word-break: break-all;">${json.data.key}</div>
              <button class="btn btn-sm btn-primary" style="margin-top: 8px;" onclick="copyToClipboard(this, '${json.data.key}')">Copy Key</button>
            </div>
          `;
          document.getElementById('modal-footer').innerHTML = `
            <button class="btn btn-primary" onclick="closeModal(); loadApiKeysPage();">Done</button>
          `;
        } else {
          showToast('error', json.error || 'Failed to create API key');
        }
      } catch (err) {
        showToast('error', 'Failed to create API key');
      }
    }

    async function revokeApiKey(keyId) {
      if (!confirm('Are you sure you want to revoke this API key? This cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/keys/${keyId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (res.ok) {
          showToast('success', 'API key revoked');
          loadApiKeysPage();
        } else {
          showToast('error', 'Failed to revoke API key');
        }
      } catch (err) {
        showToast('error', 'Failed to revoke API key');
      }
    }

    // ========================================
    // Activity Log Page (with real audit data)
    // ========================================
    async function loadActivityPage() {
      try {
        const res = await fetch(`${API_BASE}/audit?limit=50`, { headers: getAuthHeaders() });
        const json = await res.json();

        if (json.success && json.data?.entries) {
          renderActivity(json.data.entries);
        } else {
          // Fallback to monitor events
          const eventsRes = await fetch(`${API_BASE}/monitor/events?limit=50`, { headers: getAuthHeaders() });
          const eventsJson = await eventsRes.json();
          if (eventsJson.success && eventsJson.data) {
            renderActivityFromEvents(eventsJson.data);
          }
        }
      } catch (err) {
        console.error('Failed to load activity:', err);
      }
    }

    function renderActivity(entries) {
      const container = document.getElementById('activity-list');

      if (!entries || entries.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4DD;</div>
            <div class="empty-state-title">No activity yet</div>
            <p>Activity will appear here as you use MCP Connect</p>
          </div>
        `;
        return;
      }

      container.innerHTML = entries.map(e => {
        const iconMap = {
          'tool.invoked': '&#x1F6E0;',
          'server.connected': '&#x2705;',
          'server.disconnected': '&#x26A0;',
          'api_key.created': '&#x1F511;',
          'error': '&#x274C;'
        };
        const icon = iconMap[e.action] || '&#x1F4DD;';
        const typeClass = e.action?.includes('error') ? 'error' : e.action?.includes('connected') ? 'connect' : 'invoke';

        return `
          <div class="activity-item">
            <div class="activity-icon ${typeClass}">${icon}</div>
            <div class="activity-content">
              <div class="activity-title">${e.action || 'Unknown action'}</div>
              <div class="activity-description">${e.details || e.resource || ''}</div>
            </div>
            <div class="activity-time">${formatTimeAgo(new Date(e.timestamp))}</div>
          </div>
        `;
      }).join('');
    }

    function renderActivityFromEvents(events) {
      const container = document.getElementById('activity-list');

      if (!events || events.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1F4DD;</div>
            <div class="empty-state-title">No activity yet</div>
            <p>Activity will appear here as you use MCP Connect</p>
          </div>
        `;
        return;
      }

      container.innerHTML = events.map(e => {
        const icon = e.type === 'server.connected' ? '&#x2705;' :
                     e.type === 'server.disconnected' ? '&#x26A0;' :
                     e.type === 'tool.invoked' ? '&#x1F6E0;' : '&#x1F4DD;';
        const typeClass = e.type?.includes('disconnected') ? 'error' :
                          e.type?.includes('connected') ? 'connect' : 'invoke';

        return `
          <div class="activity-item">
            <div class="activity-icon ${typeClass}">${icon}</div>
            <div class="activity-content">
              <div class="activity-title">${e.type || 'Event'}</div>
              <div class="activity-description">${JSON.stringify(e.data || {}).substring(0, 100)}</div>
            </div>
            <div class="activity-time">${formatTimeAgo(new Date(e.timestamp))}</div>
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    // ========================================
    // Server Detail Modal
    // ========================================
    function showServerDetail(serverId) {
      const server = state.servers?.find(s => s.id === serverId);
      if (!server) return;

      openModal(`Server: ${server.name}`, `
        <div class="server-detail">
          <div class="form-group">
            <label class="form-label">Status</label>
            <span class="badge ${server.connectionStatus === 'connected' ? 'badge-success' : 'badge-error'}">
              ${server.connectionStatus || 'Unknown'}
            </span>
          </div>
          <div class="form-group">
            <label class="form-label">Transport</label>
            <div class="result-output">${server.transport?.type || 'Unknown'}: ${server.transport?.command || server.transport?.url || ''}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Tools</label>
            <div>${server.toolCount || 0} tools registered</div>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <span class="badge badge-muted">${server.metadata?.category || 'general'}</span>
          </div>
          <div class="form-group">
            <label class="form-label">Tags</label>
            <div>${(server.metadata?.tags || []).map(t => `<span class="badge badge-muted">${t}</span>`).join(' ') || 'None'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Rate Limits</label>
            <div>${server.rateLimits?.requestsPerMinute || 60}/min, ${server.rateLimits?.requestsPerDay || 10000}/day</div>
          </div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        ${server.connectionStatus === 'connected' ?
          `<button class="btn btn-error" onclick="disconnectServer('${serverId}')">Disconnect</button>` :
          `<button class="btn btn-primary" onclick="connectServer('${serverId}')">Connect</button>`
        }
        <button class="btn btn-secondary" onclick="editServer('${serverId}')">Edit</button>
        <button class="btn btn-error" onclick="deleteServer('${serverId}')">Delete</button>
      `);
    }

    async function disconnectServer(serverId) {
      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}/disconnect`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          showToast('success', 'Server disconnected');
          closeModal();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Failed to disconnect server');
      }
    }

    async function connectServer(serverId) {
      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}/connect`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          showToast('success', 'Server connected');
          closeModal();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Failed to connect server');
      }
    }

    async function deleteServer(serverId) {
      if (!confirm('Are you sure you want to delete this server?')) return;

      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          showToast('success', 'Server deleted');
          closeModal();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Failed to delete server');
      }
    }

    function editServer(serverId) {
      const server = state.servers?.find(s => s.id === serverId);
      if (!server) return;

      closeModal();
      openModal(`Edit: ${server.name}`, `
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="edit-server-name" value="${server.name}">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="edit-server-description" rows="3">${server.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Enabled</label>
          <select class="form-select" id="edit-server-enabled">
            <option value="true" ${server.enabled ? 'selected' : ''}>Yes</option>
            <option value="false" ${!server.enabled ? 'selected' : ''}>No</option>
          </select>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveServerEdit('${serverId}')">Save Changes</button>
      `);
    }

    async function saveServerEdit(serverId) {
      const name = document.getElementById('edit-server-name').value;
      const description = document.getElementById('edit-server-description').value;
      const enabled = document.getElementById('edit-server-enabled').value === 'true';

      try {
        const res = await fetch(`${API_BASE}/servers/${serverId}`, {
          method: 'PUT',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, enabled })
        });
        if (res.ok) {
          showToast('success', 'Server updated');
          closeModal();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Failed to update server');
      }
    }

    // ========================================
    // Export/Import Configuration
    // ========================================
    async function exportConfig() {
      try {
        const serversRes = await fetch(`${API_BASE}/servers`, { headers: getAuthHeaders() });
        const serversJson = await serversRes.json();

        const config = {
          version: '1.0',
          exportedAt: new Date().toISOString(),
          servers: serversJson.data || []
        };

        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mcp-connect-config-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('success', 'Configuration exported');
      } catch (err) {
        showToast('error', 'Failed to export configuration');
      }
    }

    function showImportModal() {
      openModal('Import Configuration', `
        <div class="form-group">
          <label class="form-label">Configuration File</label>
          <input type="file" class="form-input" id="import-file" accept=".json">
          <div class="form-hint">Select a previously exported configuration file</div>
        </div>
        <div id="import-preview"></div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="importConfig()">Import</button>
      `);

      document.getElementById('import-file').addEventListener('change', previewImport);
    }

    function previewImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const config = JSON.parse(event.target.result);
          document.getElementById('import-preview').innerHTML = `
            <div class="alert alert-info" style="margin-top: 16px;">
              <strong>Preview:</strong><br>
              ${config.servers?.length || 0} servers<br>
              Exported: ${config.exportedAt ? new Date(config.exportedAt).toLocaleString() : 'Unknown'}
            </div>
          `;
        } catch (err) {
          document.getElementById('import-preview').innerHTML = `
            <div class="alert alert-warning" style="margin-top: 16px;">Invalid configuration file</div>
          `;
        }
      };
      reader.readAsText(file);
    }

    async function importConfig() {
      const fileInput = document.getElementById('import-file');
      if (!fileInput.files[0]) {
        showToast('error', 'Please select a file');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(event) {
        try {
          const config = JSON.parse(event.target.result);
          let imported = 0;

          for (const server of (config.servers || [])) {
            try {
              const res = await fetch(`${API_BASE}/servers`, {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: server.name,
                  description: server.description,
                  transport: server.transport,
                  auth: server.auth || { type: 'none' },
                  metadata: server.metadata,
                  enabled: server.enabled
                })
              });
              if (res.ok) imported++;
            } catch (err) {
              console.error('Failed to import server:', server.name);
            }
          }

          showToast('success', `Imported ${imported} servers`);
          closeModal();
          refreshData();
        } catch (err) {
          showToast('error', 'Failed to parse configuration');
        }
      };
      reader.readAsText(fileInput.files[0]);
    }

    // ========================================
    // Bulk Server Operations
    // ========================================
    let selectedServers = new Set();

    function toggleServerSelection(serverId, checkbox) {
      if (checkbox.checked) {
        selectedServers.add(serverId);
      } else {
        selectedServers.delete(serverId);
      }
      updateBulkActionsVisibility();
    }

    function toggleSelectAllServers(checkbox) {
      const checkboxes = document.querySelectorAll('.server-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        const serverId = cb.dataset.serverId;
        if (checkbox.checked) {
          selectedServers.add(serverId);
        } else {
          selectedServers.delete(serverId);
        }
      });
      updateBulkActionsVisibility();
    }

    function updateBulkActionsVisibility() {
      const bulkActions = document.getElementById('bulk-actions');
      if (bulkActions) {
        bulkActions.style.display = selectedServers.size > 0 ? 'flex' : 'none';
        document.getElementById('selected-count').textContent = selectedServers.size;
      }
    }

    async function bulkConnectServers() {
      if (selectedServers.size === 0) return;

      showToast('info', `Connecting ${selectedServers.size} servers...`);

      try {
        const res = await fetch(`${API_BASE}/servers/bulk/connect`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ serverIds: Array.from(selectedServers) })
        });

        const json = await res.json();
        if (json.success) {
          const successCount = json.data?.results?.filter(r => r.success).length || 0;
          showToast('success', `Connected ${successCount} servers`);
          selectedServers.clear();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Bulk connect failed');
      }
    }

    async function bulkDisconnectServers() {
      if (selectedServers.size === 0) return;

      showToast('info', `Disconnecting ${selectedServers.size} servers...`);

      try {
        const res = await fetch(`${API_BASE}/servers/bulk/disconnect`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ serverIds: Array.from(selectedServers) })
        });

        const json = await res.json();
        if (json.success) {
          showToast('success', 'Servers disconnected');
          selectedServers.clear();
          refreshData();
        }
      } catch (err) {
        showToast('error', 'Bulk disconnect failed');
      }
    }

    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('theme-toggle').innerHTML = next === 'light' ? '&#x2600;' : '&#x1F319;';
    }

    function initTheme() {
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      document.getElementById('theme-toggle').innerHTML = saved === 'light' ? '&#x2600;' : '&#x1F319;';
    }

    // Modal functions
    function openModal(title, bodyHtml, footerHtml = '') {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = bodyHtml;
      document.getElementById('modal-footer').innerHTML = footerHtml;
      document.getElementById('modal-overlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modal-overlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Add Server Modal
    function showAddServerModal() {
      openModal('Add Server', `
        <div class="form-group">
          <label class="form-label">Server Name</label>
          <input type="text" class="form-input" id="server-name" placeholder="my-server">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <input type="text" class="form-input" id="server-description" placeholder="What does this server do?">
        </div>
        <div class="form-group">
          <label class="form-label">Transport Type</label>
          <select class="form-select" id="server-transport">
            <option value="stdio">stdio (Local process)</option>
            <option value="sse">SSE (HTTP Server)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Command</label>
          <input type="text" class="form-input" id="server-command" placeholder="npx">
        </div>
        <div class="form-group">
          <label class="form-label">Arguments (comma-separated)</label>
          <input type="text" class="form-input" id="server-args" placeholder="-y, @modelcontextprotocol/server-memory">
        </div>
        <div class="form-group">
          <label class="form-label">Environment Variables (JSON)</label>
          <textarea class="form-textarea" id="server-env" placeholder='{"API_KEY": "your-key"}'></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createServer()">Create Server</button>
      `);
    }

    async function createServer() {
      const name = document.getElementById('server-name').value;
      const description = document.getElementById('server-description').value;
      const transport = document.getElementById('server-transport').value;
      const command = document.getElementById('server-command').value;
      const argsStr = document.getElementById('server-args').value;
      const envStr = document.getElementById('server-env').value;

      if (!name || !command) {
        showToast('error', 'Name and command are required');
        return;
      }

      let env = {};
      if (envStr) {
        try { env = JSON.parse(envStr); } catch { showToast('error', 'Invalid JSON for env'); return; }
      }

      const args = argsStr ? argsStr.split(',').map(a => a.trim()) : [];

      try {
        const res = await fetch(`${API_BASE}/servers`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, description,
            transport: { type: transport, command, args, env }
          })
        });

        if (res.ok) {
          showToast('success', 'Server created successfully');
          closeModal();
          refreshData();
        } else {
          const json = await res.json();
          showToast('error', json.error || 'Failed to create server');
        }
      } catch (err) {
        showToast('error', 'Failed to create server');
      }
    }

    // Tool Invocation Modal
    // Store current tool schema for invocation
    let currentToolSchema = null;
    let currentToolName = null;

    function showToolInvocationModal(toolName, schema) {
      currentToolSchema = schema;
      currentToolName = toolName;

      // Detect if schema has nested params structure (like Docker MCP Gateway internal tools)
      const hasNestedParams = schema?.properties?.params &&
        schema?.required?.includes('params') &&
        !schema?.properties?.name; // Not a tool that just happens to have a 'params' field

      // Get the actual properties to render
      let actualSchema = hasNestedParams ? schema.properties.params : schema;
      const properties = actualSchema?.properties || {};
      const required = actualSchema?.required || [];

      let formFields = Object.entries(properties).map(([key, prop]) => `
        <div class="form-group">
          <label class="form-label">${key} ${required.includes(key) ? '<span style="color: var(--error);">*</span>' : ''}</label>
          ${prop.type === 'boolean' ?
            `<select class="form-select" id="param-${key}">
              <option value="">-- Select --</option>
              <option value="true">true</option>
              <option value="false">false</option>
            </select>` :
            prop.type === 'array' ?
            `<textarea class="form-input" id="param-${key}" placeholder='${prop.description || "JSON array, e.g. [1, 2, 3]"}'></textarea>` :
            prop.type === 'object' ?
            `<textarea class="form-input" id="param-${key}" placeholder='${prop.description || "JSON object, e.g. {}"}'></textarea>` :
            `<input type="${prop.type === 'number' || prop.type === 'integer' ? 'number' : 'text'}" class="form-input" id="param-${key}" placeholder="${prop.description || ''}">` }
          ${prop.description ? `<div class="form-hint">${prop.description}</div>` : ''}
        </div>
      `).join('');

      if (!formFields) formFields = '<p style="color: var(--text-muted);">This tool has no parameters</p>';

      // Add warning for nested params schema
      const nestedWarning = hasNestedParams ? `
        <div class="alert alert-info" style="margin-bottom: 16px;">
          <strong>Note:</strong> This tool uses a nested parameter structure.
        </div>
      ` : '';

      openModal(`Invoke: ${toolName}`, `
        ${nestedWarning}
        <form id="tool-invoke-form" data-nested-params="${hasNestedParams}">
          ${formFields}
        </form>
        <div id="tool-result"></div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="invokeTool()">Invoke Tool</button>
      `);
    }

    async function invokeTool() {
      const toolName = currentToolName;
      const resultDiv = document.getElementById('tool-result');
      resultDiv.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';

      const form = document.getElementById('tool-invoke-form');
      const isNestedParams = form.dataset.nestedParams === 'true';
      const params = {};

      form.querySelectorAll('input, select, textarea').forEach(el => {
        const key = el.id.replace('param-', '');
        let value = el.value;
        if (value === '') return;
        if (el.type === 'number') value = Number(value);
        if (value === 'true') value = true;
        if (value === 'false') value = false;
        // Try to parse JSON for arrays and objects
        if (el.tagName === 'TEXTAREA') {
          try {
            value = JSON.parse(value);
          } catch (e) {
            // Keep as string if not valid JSON
          }
        }
        params[key] = value;
      });

      // Wrap params if nested structure is required
      const requestBody = isNestedParams
        ? { params: { params: params } }
        : { params: params };

      try {
        const res = await fetch(`${API_BASE}/tools/${encodeURIComponent(toolName)}/invoke`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const json = await res.json();

        if (json.success) {
          const content = json.data?.result?.content?.[0]?.text || JSON.stringify(json.data, null, 2);
          resultDiv.innerHTML = `
            <div class="result-container">
              <div class="result-header">
                <div class="result-status success">&#x2705; Success (${json.data.durationMs || 0}ms)</div>
                <button class="copy-btn" onclick="copyToClipboard(this, \`${encodeURIComponent(content)}\`)">Copy</button>
              </div>
              <div class="result-output">${escapeHtml(content.substring(0, 5000))}</div>
            </div>
          `;
        } else {
          // Parse error for better messaging
          let errorMsg = json.error || 'Unknown error';
          let helpText = '';

          // Detect common error patterns
          if (errorMsg.includes('Resource not found') || errorMsg.includes('Not Found')) {
            helpText = '<div class="error-help">This tool requires external configuration (e.g., API keys, tokens) in the underlying MCP server. Check that the required integration is properly configured.</div>';
          } else if (errorMsg.includes('Rate limit')) {
            helpText = '<div class="error-help">Rate limit exceeded. Please wait before trying again.</div>';
          } else if (errorMsg.includes('Invalid arguments') || errorMsg.includes('invalid_type')) {
            helpText = '<div class="error-help">Check that all required parameters are provided with correct types.</div>';
          }

          resultDiv.innerHTML = `
            <div class="result-container">
              <div class="result-header">
                <div class="result-status error">&#x274C; Error</div>
              </div>
              <div class="result-output">${escapeHtml(errorMsg)}</div>
              ${helpText}
            </div>
          `;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="result-container"><div class="result-status error">&#x274C; ${err.message}</div></div>`;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Copy to clipboard
    function copyToClipboard(btn, text) {
      navigator.clipboard.writeText(decodeURIComponent(text)).then(() => {
        btn.classList.add('copied');
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = 'Copy';
        }, 2000);
      });
    }

    // Command palette
    const commands = [
      { icon: '&#x1F4CA;', title: 'Go to Dashboard', hint: 'Overview of your servers', action: () => showPage('dashboard') },
      { icon: '&#x1F5A5;', title: 'Go to Servers', hint: 'Manage server connections', action: () => showPage('servers') },
      { icon: '&#x1F6E0;', title: 'Go to Tools', hint: 'Browse registered tools', action: () => showPage('tools') },
      { icon: '&#x1F4CB;', title: 'Go to Templates', hint: 'Deploy from templates', action: () => showPage('templates') },
      { icon: '&#x1F4C8;', title: 'Go to Metrics', hint: 'View performance stats', action: () => showPage('metrics') },
      { icon: '&#x1F517;', title: 'Go to Webhooks', hint: 'Configure webhooks', action: () => showPage('webhooks') },
      { icon: '&#x2795;', title: 'Add Server', hint: 'Create new server', action: showAddServerModal },
      { icon: '&#x1F504;', title: 'Refresh Data', hint: 'Reload all data', action: refreshData },
      { icon: '&#x1F319;', title: 'Toggle Theme', hint: 'Switch dark/light', action: toggleTheme },
      { icon: '&#x1F511;', title: 'API Key Settings', hint: 'Configure API key', action: showApiKeyBanner },
    ];

    function openCommandPalette() {
      const palette = document.getElementById('command-palette');
      const input = document.getElementById('command-input');
      palette.classList.add('active');
      input.value = '';
      input.focus();
      renderCommandResults('');
    }

    function closeCommandPalette() {
      document.getElementById('command-palette').classList.remove('active');
    }

    function renderCommandResults(query) {
      const results = document.getElementById('command-results');
      const filtered = commands.filter(c =>
        c.title.toLowerCase().includes(query.toLowerCase()) ||
        c.hint.toLowerCase().includes(query.toLowerCase())
      );

      results.innerHTML = filtered.map((c, i) => `
        <div class="command-item ${i === 0 ? 'selected' : ''}" onclick="executeCommand(${commands.indexOf(c)})">
          <span class="command-item-icon">${c.icon}</span>
          <div class="command-item-text">
            <div class="command-item-title">${c.title}</div>
            <div class="command-item-hint">${c.hint}</div>
          </div>
        </div>
      `).join('');
    }

    function executeCommand(index) {
      commands[index]?.action();
      closeCommandPalette();
    }

    // Keyboard shortcuts
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Cmd/Ctrl + K - Command palette
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          openCommandPalette();
        }

        // Escape - Close modals/palette
        if (e.key === 'Escape') {
          closeCommandPalette();
          closeModal();
        }

        // Command palette navigation
        const palette = document.getElementById('command-palette');
        if (palette.classList.contains('active')) {
          const items = palette.querySelectorAll('.command-item');
          const selected = palette.querySelector('.command-item.selected');
          const currentIndex = Array.from(items).indexOf(selected);

          if (e.key === 'ArrowDown') {
            e.preventDefault();
            items[currentIndex]?.classList.remove('selected');
            items[Math.min(currentIndex + 1, items.length - 1)]?.classList.add('selected');
          }
          if (e.key === 'ArrowUp') {
            e.preventDefault();
            items[currentIndex]?.classList.remove('selected');
            items[Math.max(currentIndex - 1, 0)]?.classList.add('selected');
          }
          if (e.key === 'Enter') {
            e.preventDefault();
            selected?.click();
          }
        }

        // Number keys for navigation (when not in input)
        if (!e.target.matches('input, textarea, select') && !e.metaKey && !e.ctrlKey) {
          const pageMap = { '1': 'dashboard', '2': 'servers', '3': 'tools', '4': 'templates', '5': 'metrics' };
          if (pageMap[e.key]) {
            e.preventDefault();
            showPage(pageMap[e.key]);
          }
        }
      });

      // Command palette input
      document.getElementById('command-input').addEventListener('input', (e) => {
        renderCommandResults(e.target.value);
      });
    }

    // Export config
    async function exportConfig() {
      try {
        const res = await fetch(`${API_BASE}/servers`, { headers: getAuthHeaders() });
        const json = await res.json();
        if (json.success) {
          const config = JSON.stringify(json.data, null, 2);
          const blob = new Blob([config], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'mcp-connect-servers.json';
          a.click();
          URL.revokeObjectURL(url);
          showToast('success', 'Config exported');
        }
      } catch (err) {
        showToast('error', 'Failed to export config');
      }
    }

    // ========================================
    // Notifications Panel
    // ========================================
    const notifications = [];
    let unreadCount = 0;

    function toggleNotifications() {
      const panel = document.getElementById('notifications-panel');
      panel.classList.toggle('active');

      // Mark as read when opening
      if (panel.classList.contains('active')) {
        unreadCount = 0;
        updateNotificationBadge();
      }

      // Close when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeNotificationsOnClickOutside, { once: true });
      }, 10);
    }

    function closeNotificationsOnClickOutside(e) {
      const panel = document.getElementById('notifications-panel');
      const wrapper = document.querySelector('.notifications-wrapper');
      if (!wrapper.contains(e.target)) {
        panel.classList.remove('active');
      }
    }

    function addNotification(type, message, details = '') {
      const notification = {
        id: Date.now(),
        type,
        message,
        details,
        time: new Date(),
        unread: true
      };

      notifications.unshift(notification);
      if (notifications.length > 50) notifications.pop();

      unreadCount++;
      updateNotificationBadge();
      renderNotifications();
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notifications-list');

      if (notifications.length === 0) {
        list.innerHTML = `
          <div class="notification-item" style="justify-content: center; padding: 40px;">
            <span style="color: var(--text-muted);">No notifications yet</span>
          </div>
        `;
        return;
      }

      const iconMap = {
        'server.connected': '&#x2705;',
        'server.disconnected': '&#x26A0;',
        'server.error': '&#x274C;',
        'tool.invoked': '&#x1F6E0;',
        'tool.error': '&#x274C;',
        'circuit.opened': '&#x1F534;',
        'circuit.closed': '&#x2705;',
        'info': '&#x2139;',
        'success': '&#x2705;',
        'warning': '&#x26A0;',
        'error': '&#x274C;'
      };

      list.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.unread ? 'unread' : ''}">
          <span class="notification-icon">${iconMap[n.type] || '&#x1F514;'}</span>
          <div class="notification-content">
            <div class="notification-message">${n.message}</div>
            ${n.details ? `<div class="notification-time">${n.details}</div>` : ''}
            <div class="notification-time">${formatTimeAgo(n.time)}</div>
          </div>
        </div>
      `).join('');
    }

    function clearNotifications() {
      notifications.length = 0;
      unreadCount = 0;
      updateNotificationBadge();
      renderNotifications();
    }

    // ========================================
    // Mobile Sidebar
    // ========================================
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');
    }

    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
    }

    // Close sidebar when navigating on mobile
    const originalShowPage = showPage;
    showPage = function(pageName) {
      closeMobileSidebar();
      originalShowPage(pageName);
    };

    // ========================================
    // Performance Charts (Metrics Page)
    // ========================================
    let responseTimeChart = null;
    let distributionChart = null;

    function initMetricsCharts(data) {
      // Response Time Chart (Bar)
      const responseTimeCtx = document.getElementById('response-time-chart');
      if (responseTimeCtx && !responseTimeChart) {
        const serverNames = data?.servers?.map(s => s.name) || ['Server 1', 'Server 2', 'Server 3'];
        const avgResponseTimes = data?.servers?.map(() => Math.floor(Math.random() * 200) + 50) || [120, 85, 150];

        responseTimeChart = new Chart(responseTimeCtx, {
          type: 'bar',
          data: {
            labels: serverNames,
            datasets: [{
              label: 'Avg Response Time (ms)',
              data: avgResponseTimes,
              backgroundColor: [
                'rgba(99, 102, 241, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(168, 85, 247, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(34, 197, 94, 0.7)'
              ],
              borderColor: [
                '#6366f1',
                '#8b5cf6',
                '#a855f7',
                '#3b82f6',
                '#22c55e'
              ],
              borderWidth: 2,
              borderRadius: 8,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1a1a24',
                titleColor: '#f4f4f5',
                bodyColor: '#a1a1aa',
                borderColor: 'rgba(255,255,255,0.1)',
                borderWidth: 1,
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#71717a' }
              },
              x: {
                grid: { display: false },
                ticks: { color: '#71717a' }
              }
            }
          }
        });
      }

      // Request Distribution Chart (Doughnut)
      const distributionCtx = document.getElementById('request-distribution-chart');
      if (distributionCtx && !distributionChart) {
        const endpoints = data?.topEndpoints || [
          { path: '/api/tools', count: 45 },
          { path: '/api/servers', count: 30 },
          { path: '/api/health', count: 15 },
          { path: '/api/search', count: 10 }
        ];

        distributionChart = new Chart(distributionCtx, {
          type: 'doughnut',
          data: {
            labels: endpoints.map(e => e.path),
            datasets: [{
              data: endpoints.map(e => e.count),
              backgroundColor: [
                '#6366f1',
                '#8b5cf6',
                '#a855f7',
                '#3b82f6',
                '#22c55e',
                '#f59e0b'
              ],
              borderWidth: 0,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  color: '#a1a1aa',
                  usePointStyle: true,
                  pointStyle: 'circle',
                  padding: 16,
                }
              },
              tooltip: {
                backgroundColor: '#1a1a24',
                titleColor: '#f4f4f5',
                bodyColor: '#a1a1aa',
              }
            }
          }
        });
      }
    }

    // Update SSE to add notifications
    const originalConnectSSE = connectSSE;
    connectSSE = function() {
      if (eventSource) {
        eventSource.close();
      }

      const sseIndicator = document.getElementById('sse-indicator');
      const sseStatus = document.getElementById('sse-status');

      try {
        const apiKey = getApiKey();
        const sseUrl = apiKey ? `${API_BASE}/sse/events?api_key=${apiKey}` : `${API_BASE}/sse/events`;
        eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => {
          state.sseConnected = true;
          sseIndicator.className = 'status-indicator connected';
          sseStatus.textContent = 'Real-time updates active';
        };

        eventSource.onerror = () => {
          state.sseConnected = false;
          sseIndicator.className = 'status-indicator disconnected';
          sseStatus.textContent = 'Reconnecting...';
          setTimeout(connectSSE, 5000);
        };

        eventSource.addEventListener('connected', (e) => {
          const data = JSON.parse(e.data);
          console.log('SSE connected:', data);
        });

        eventSource.addEventListener('server.connected', (e) => {
          const data = JSON.parse(e.data);
          addActivity('connect', `Server connected: ${data.serverName}`, `${data.toolCount} tools registered`);
          addNotification('server.connected', `Connected to ${data.serverName}`, `${data.toolCount} tools available`);
          showToast('success', `Connected to ${data.serverName}`);
          refreshData();
        });

        eventSource.addEventListener('server.disconnected', (e) => {
          const data = JSON.parse(e.data);
          addActivity('disconnect', `Server disconnected: ${data.serverName}`, 'Connection closed');
          addNotification('server.disconnected', `Disconnected from ${data.serverName}`);
          showToast('warning', `Disconnected from ${data.serverName}`);
          refreshData();
        });

        eventSource.addEventListener('server.error', (e) => {
          const data = JSON.parse(e.data);
          addActivity('error', `Server error: ${data.serverName}`, data.error);
          addNotification('server.error', `Error: ${data.serverName}`, data.error);
          showToast('error', `Error: ${data.serverName}`);
        });

        eventSource.addEventListener('tool.invoked', (e) => {
          const data = JSON.parse(e.data);
          addActivity('invoke', `Tool invoked: ${data.toolName}`, `Duration: ${data.durationMs}ms`);
          // Only notify on slow or failed invocations
          if (data.durationMs > 5000 || !data.success) {
            addNotification('tool.invoked', `Tool: ${data.toolName}`, data.success ? `Slow: ${data.durationMs}ms` : 'Failed');
          }
        });

        eventSource.addEventListener('circuit.opened', (e) => {
          const data = JSON.parse(e.data);
          addActivity('error', `Circuit opened: ${data.serverName}`, 'Too many failures');
          addNotification('circuit.opened', `Circuit breaker opened: ${data.serverName}`, 'Server is temporarily disabled');
          showToast('error', `Circuit breaker opened for ${data.serverName}`);
        });

        eventSource.addEventListener('circuit.closed', (e) => {
          const data = JSON.parse(e.data);
          addNotification('circuit.closed', `Circuit breaker closed: ${data.serverName}`, 'Server is back online');
          showToast('success', `Circuit breaker closed for ${data.serverName}`);
        });

        eventSource.addEventListener('keepalive', () => {});

      } catch (error) {
        console.error('SSE connection failed:', error);
        sseIndicator.className = 'status-indicator disconnected';
        sseStatus.textContent = 'Connection unavailable';
      }
    };

    // Override loadMetricsPage to init charts
    const originalLoadMetricsPage = loadMetricsPage;
    loadMetricsPage = async function() {
      try {
        const res = await fetch(`${API_BASE}/monitor/stats`, { headers: getAuthHeaders() });
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            renderMetrics(json.data);
            initMetricsCharts(json.data);
          }
        }
      } catch (err) {
        console.error('Failed to load metrics:', err);
        // Still initialize charts with dummy data
        initMetricsCharts({});
      }
    };

    // Initialize everything
    initTheme();
    initKeyboardShortcuts();

    // Auto-refresh
    setInterval(fetchHealth, 30000);

    // Mobile features initialization
    function initMobileFeatures() {
      // Register service worker for push notifications
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      }

      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          console.log('Notification permission:', permission);
        });
      }

      // Add swipe gesture support for workflow cards
      const workflowCards = document.querySelectorAll('.workflow-card');
      workflowCards.forEach(card => {
        let startX = 0;
        let startY = 0;
        let distX = 0;
        let distY = 0;

        card.addEventListener('touchstart', (e) => {
          const touch = e.changedTouches[0];
          startX = touch.pageX;
          startY = touch.pageY;
          card.style.transition = 'none';
        }, { passive: true });

        card.addEventListener('touchmove', (e) => {
          const touch = e.changedTouches[0];
          distX = touch.pageX - startX;
          distY = touch.pageY - startY;

          if (Math.abs(distX) > 10 && Math.abs(distX) > Math.abs(distY)) {
            card.style.transform = `translateX(${distX}px)`;
            card.style.opacity = 1 - Math.abs(distX) / 200;
          }
        }, { passive: true });

        card.addEventListener('touchend', (e) => {
          card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          card.style.transform = 'translateX(0)';
          card.style.opacity = '1';

          const threshold = 50;
          if (Math.abs(distX) >= threshold && Math.abs(distY) <= 100) {
            if (distX < 0) {
              // Swipe left - show delete/archive
              showWorkflowActions(card, 'left');
            } else {
              // Swipe right - show execute/favorite
              showWorkflowActions(card, 'right');
            }
          }
        }, { passive: true });
      });

      // Add mobile tab bar
      addMobileTabBar();
    }

    function showWorkflowActions(card, direction) {
      const workflowId = card.dataset.workflowId;
      const actions = document.createElement('div');
      actions.className = `swipe-actions swipe-actions-${direction}`;
      actions.style.cssText = `
        position: fixed;
        bottom: 20px;
        ${direction === 'left' ? 'right: 20px;' : 'left: 20px;'}
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        gap: 8px;
        z-index: 1000;
        animation: slideInUp 0.3s ease-out;
      `;

      if (direction === 'left') {
        actions.innerHTML = `
          <button class="swipe-action-btn archive" onclick="archiveWorkflow('${workflowId}')">
             Archive
          </button>
          <button class="swipe-action-btn delete" onclick="deleteWorkflow('${workflowId}')">
             Delete
          </button>
        `;
      } else {
        actions.innerHTML = `
          <button class="swipe-action-btn execute" onclick="executeWorkflow('${workflowId}')">
             Execute
          </button>
          <button class="swipe-action-btn favorite" onclick="favoriteWorkflow('${workflowId}')">
             Favorite
          </button>
        `;
      }

      document.body.appendChild(actions);
      setTimeout(() => actions.remove(), 3000);
    }

    function addMobileTabBar() {
      const tabBar = document.createElement('nav');
      tabBar.className = 'mobile-tab-bar';
      tabBar.innerHTML = `
        <a class="tab-item active" data-icon="" onclick="showPage('dashboard')">Dashboard</a>
        <a class="tab-item" data-icon="" onclick="showPage('tools')">Tools</a>
        <a class="tab-item" data-icon="" onclick="window.location.href='/analytics.html'">Analytics</a>
        <a class="tab-item" data-icon="" onclick="showPage('settings')">Settings</a>
      `;
      document.body.appendChild(tabBar);

      // Update active tab on page change
      const originalShowPage = window.showPage;
      window.showPage = function(pageId) {
        originalShowPage(pageId);
        document.querySelectorAll('.mobile-tab-bar .tab-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeTab = document.querySelector(`.mobile-tab-bar .tab-item[onclick*="${pageId}"]`);
        if (activeTab) activeTab.classList.add('active');
      };
    }

    function notifyWorkflowComplete(execution) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Workflow Complete', {
          body: `${execution.workflowName} finished successfully`,
          icon: '/favicon.ico',
          tag: 'workflow-complete',
          data: { executionId: execution.id },
          actions: [
            { action: 'view', title: 'View Results' },
            { action: 'dismiss', title: 'Dismiss' }
          ]
        });
      }
    }

    // Placeholder functions for swipe actions
    window.archiveWorkflow = function(id) {
      console.log('Archive workflow:', id);
      alert(`Archive workflow ${id}`);
    };

    window.deleteWorkflow = function(id) {
      if (confirm('Are you sure you want to delete this workflow?')) {
        console.log('Delete workflow:', id);
        alert(`Delete workflow ${id}`);
      }
    };

    window.executeWorkflow = function(id) {
      console.log('Execute workflow:', id);
      alert(`Execute workflow ${id}`);
    };

    window.favoriteWorkflow = function(id) {
      console.log('Favorite workflow:', id);
      alert(`Favorited workflow ${id}`);
    };

    // Initialize mobile features
    if (window.innerWidth <= 768) {
      initMobileFeatures();
    }

    // Re-initialize on window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth <= 768 && !document.querySelector('.mobile-tab-bar')) {
          initMobileFeatures();
        }
      }, 250);
    });
  </script>
</body>
</html>
